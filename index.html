<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roger's AI Assistant / ãƒ­ã‚¸ãƒ£ãƒ¼ã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</title>
    <style>
        /* General Reset and Body Styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* Language Selection Screen Styling */
        .language-selection-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh; /* Take full viewport height */
            width: 100%;
            max-width: 450px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.6s ease-out;
            padding: 30px;
            text-align: center;
        }

        .language-selection-screen h1 {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 30px;
            font-weight: 600;
        }

        .language-button {
            padding: 15px 30px;
            margin: 10px 0;
            width: 80%; /* Make buttons take more width */
            max-width: 250px; /* Limit max width */
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .language-button.english {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
        }

        .language-button.japanese {
            background: linear-gradient(45deg, #FFC107, #FF9800);
            color: white;
        }

        .language-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        /* Chat Container Styling */
        .chat-container {
            max-width: 450px;
            width: 100%;
            min-height: 600px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin-bottom: 40px;
            display: none; /* Initially hidden */
        }

        /* Chat Header Styling */
        .chat-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 20px 20px 0 0;
            position: relative;
        }
        .profile-pic {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 10px;
            border: 3px solid white;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            transition: opacity 0.3s ease-in-out;
        }
        .profile-pic img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            object-position: 50% 10%; /* Adjusted to show the face even better */
        }
        .profile-pic .avatar-fallback {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            border-radius: 50%;
        }
        .chat-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
            transition: opacity 0.3s ease-in-out;
        }
        .chat-subtitle {
            font-size: 12px;
            opacity: 0.9;
            transition: opacity 0.3s ease-in-out;
        }

        /* Video Overlay Styling */
        .welcome-video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 20px 20px 0 0;
            z-index: 7;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }

        .welcome-video-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        /* Styling to hide header elements when video is playing */
        .chat-header.video-active .profile-pic,
        .chat-header.video-active .chat-title,
        .chat-header.video-active .chat-subtitle {
            opacity: 0;
            pointer-events: none;
        }


        /* Chat Messages Area */
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            animation: messageSlide 0.3s ease-out;
        }
        .message.bot {
            background: #f0f0f0;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .message.user {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        /* Resume Iframe Styling */
        .message.bot .resume-embed {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 10px;
            margin-top: 10px;
        }


        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: #f0f0f0;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            max-width: 80px;
            align-self: flex-start;
        }
        .typing-dots {
            display: flex;
            gap: 3px;
        }
        .typing-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #999;
            animation: typing 1.4s infinite;
        }
        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        /* Chat Input Area */
        .chat-input-container {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            background: white;
            border-radius: 0 0 20px 20px;
        }
        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            font-size: 14px;
            resize: none;
            max-height: 100px;
            min-height: 40px;
            line-height: 1.4;
            font-family: inherit;
            transition: border-color 0.2s ease-in-out;
        }
        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }
        .send-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, background-color 0.2s;
        }
        .send-btn:hover {
            transform: scale(1.1);
        }
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background: #ccc;
        }

        /* Quick Replies */
        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .quick-reply {
            padding: 8px 12px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-reply:hover {
            background: #667eea;
            color: white;
        }

        /* Message Form Styles */
        .message-form {
            flex: 1;
            padding: 20px;
            background: white;
            border-radius: 0 0 20px 20px;
            border-top: 1px solid #e0e0e0;
            overflow-y: auto;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s ease-in-out;
        }
        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }
        .form-submit-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .form-submit {
            flex: 1;
            padding: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
        }
        .form-submit:hover {
            transform: translateY(-2px);
        }
        .form-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            background: #ccc;
        }
        .generate-draft-btn {
            flex: 1;
            padding: 12px;
            background: #f0f0f0;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .generate-draft-btn:hover {
            transform: translateY(-2px);
            background: #e0e0e0;
        }
        .generate-draft-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            background: #ccc;
            color: #666;
            border-color: #999;
        }

        /* Animations */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-8px);
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        /* Scrollbar Styling */
        .chat-messages::-webkit-scrollbar,
        .message-form::-webkit-scrollbar {
            width: 4px;
        }
        .chat-messages::-webkit-scrollbar-track,
        .message-form::-webkit-scrollbar-track {
            background: transparent;
        }
        .chat-messages::-webkit-scrollbar-thumb,
        .message-form::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 2px;
        }

        /* Language Toggle Button (inside chat, now hidden by default) */
        .language-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            z-index: 10;
            display: none; /* Hide this button as initial language choice is handled by other buttons */
        }

        /* Message Timestamp */
        .message-time {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 4px;
            text-align: right;
        }
        .message.bot .message-time {
            text-align: left;
        }

        /* Close Notice (for form submission success) */
        .close-notice {
            background: #e8f5e8;
            color: #2d5a2d;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 12px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .close-notice .email-content-display {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            padding: 10px;
            border-radius: 5px;
            text-align: left;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 150px;
            overflow-y: auto;
        }

        .close-notice .copy-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .close-notice .copy-btn:hover {
            background: #764ba2;
        }

        /* Star Rating Styles */
        .chat-rating-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            border-radius: 0 0 20px 20px;
        }
        .rating-prompt {
            font-size: 14px;
            color: #333;
            margin-bottom: 10px;
        }
        .stars {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 10px;
        }
        .star {
            width: 30px;
            height: 30px;
            color: #ccc;
            cursor: pointer;
            transition: color 0.2s ease-in-out, transform 0.1s ease-out;
        }
        .star:hover {
            transform: scale(1.1);
        }
        .star.selected {
            color: #FFD700;
        }
        .rating-thank-you {
            font-size: 12px;
            color: #2d5a2d;
            margin-top: 10px;
        }

        /* Creator Signature Styles */
        .creator-signature {
            font-size: 10px;
            color: #888;
            text-align: center;
            padding: 10px;
            border-top: 1px solid #e0e0e0;
            background: white;
            border-radius: 0 0 20px 20px;
            margin-top: auto;
        }
    </style>
</head>
<body>
    <div class="language-selection-screen" id="languageSelectionScreen">
        <h1>Select your language /<br>è¨€èªã‚’é¸æŠã—ã¦ãã ã•ã„</h1>
        <button class="language-button english" data-lang="en">English</button>
        <button class="language-button japanese" data-lang="ja">æ—¥æœ¬èª</button>
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="profile-pic" id="profilePicContainer">
                <img src="https://i.imgur.com/ThRrtS2.jpeg" alt="AI Assistant" onerror="this.style.display='none'; document.getElementById('avatarFallback').style.display='flex';">
                <div class="avatar-fallback" id="avatarFallback" style="display: none;">ğŸ¤–</div>
            </div>
            <div class="chat-title">Roger's AI Assistant</div>
            <div class="chat-subtitle">ãƒ­ã‚¸ãƒ£ãƒ¼ã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</div>
            <video id="welcomeVideoPlayer" class="welcome-video-overlay" autoplay playsinline preload="auto"></video>
        </div>
        <div class="chat-messages" id="chatMessages" role="log" aria-live="polite">
            </div>
        <div class="chat-input-container" id="chatInputContainer">
            <div id="quickReplies" class="quick-replies hidden">
                </div>
            <div class="chat-input-wrapper">
                <textarea
                    id="chatInput"
                    class="chat-input"
                    placeholder="Type your message..."
                    rows="1"
                ></textarea>
                <button id="sendBtn" class="send-btn" title="Send message">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
        <div class="message-form hidden" id="messageForm">
            <form>
                <div class="form-group">
                    <label class="form-label" id="nameLabel">Your Name:</label>
                    <input type="text" id="formName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" id="companyLabel">Company:</label>
                    <input type="text" id="formCompany" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" id="emailLabel">Email:</label>
                    <input type="email" id="formEmail" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" id="messageLabel">Message for Roger:</label>
                    <textarea id="formMessage" class="form-input form-textarea" required></textarea>
                </div>
                <div class="form-submit-group">
                    <button type="button" class="generate-draft-btn" id="generateDraftBtn">
                        âœ¨ <span id="generateDraftBtnText">Draft Message</span>
                    </button>
                    <button type="submit" class="form-submit" id="submitBtn">Send Message</button>
                </div>
                <div class="close-notice hidden" id="closeNotice">
                    <p id="closeNoticeText"></p>
                </div>
            </form>
        </div>
        <div class="chat-rating-container hidden" id="chatRatingContainer">
            <p id="ratingPrompt" class="rating-prompt"></p>
            <div class="stars" id="starRating">
                <svg class="star" data-value="1" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                <svg class="star" data-value="2" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                <svg class="star" data-value="3" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                <svg class="star" data-value="4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                <svg class="star" data-value="5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
            </div>
            <p id="ratingThankYou" class="rating-thank-you hidden"></p>
        </div>

        <div class="creator-signature" id="creatorSignature"></div>
    </div>


    <script>
        // --- Global State Variables ---
        let currentLanguage = 'en';
        let conversationStep = 0;
        let userInfo = {};
        let isTyping = false;
        let waitingForScheduleConfirmation = false;
        let isLeavingMessageDirectly = false;
        let directMessageSubStep = 0;

        const GOOGLE_APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbygjlQiVtSYYoQtYOgXl2ES0iauRUsgsakygUYlbC1T1mzeeG54UnT0WD3dO6p2h9zDSg/exec';

        // --- Cached DOM Elements ---
        let chatMessagesContainer, chatInput, sendButton, quickRepliesContainer,
            chatInputContainer, messageForm, nameLabel, companyLabel, emailLabel,
            messageLabel, submitBtn, closeNotice, chatTitleElement, chatSubtitleElement,
            profilePicImg, avatarFallback, languageToggleButton, generateDraftButton,
            generateDraftButtonText, chatRatingContainer, ratingPrompt, starRatingContainer, ratingThankYou,
            closeNoticeText, creatorSignatureElement, welcomeVideoPlayer, chatHeaderElement,
            languageSelectionScreen, englishButton, japaneseButton, chatContainer;


        // --- Localization Data ---
        const messages = {
            en: {
                welcome: "ğŸ‘‹ Hello! I'm Roger's AI assistant. I'm here to connect you with Roger.",
                intro: "I can help you:\nâ€¢ Schedule a chat\nâ€¢ Leave a message\nâ€¢ Generate Professional Summary\nâ€¢ Watch Roger's Video\nâ€¢ View Resume\nâ€¢ Connect on LinkedIn",
                askName: "Great! Let's start. What's your name?",
                askCompany: "Nice to meet you, {name}! What company do you work for?",
                askPurpose: "Thanks, {name}! What brings you here today? Are you looking to:",
                professionalSummary: "Roger Gomes is a Strategic GTM and DX Leader with 20+ years of experience scaling B2B SaaS, AI, and startup ventures across APAC and North America. He specializes in 0â†’1 product launches, cross-regional program management, and digital/business transformation that accelerates operational agility and sustainable growth.\n\nHe has led over $33M in global projects, aligning diverse stakeholders across Japan, Thailand, and Australia. His Japanese is conversational (not business-level), but he has effectively managed bilingual teams of up to 16 Japanese staff using Slack, Teams, LINE, Zoom, and AI tools. Based in Japan with no visa sponsorship required, Roger is open to relocation and values cultures of ownership, continuous learning, and practical problem-solving.",
                afterRogerMessage: "Is there anything else I can help you with?\n\nFeel free to use the buttons below to schedule a chat with Roger or leave a messageâ€”whichever works best for you!",
                scheduleConfirm: "Perfect! I'll open Roger's calendar for you. You can schedule a time that works best.",
                scheduleFollowUp: "Have you finished scheduling your appointment with Roger?",
                appointmentComplete: "Excellent! Roger will receive your booking confirmation and will be prepared for your meeting. Thank you for connecting with us!",
                windowClosing: "This window will close automatically in 3 seconds...",
                messagePrompt: "I'd be happy to help you send a message to Roger. Please fill out the form below:",
                goodbye: "Thank you for your time! Feel free to reach out anytime.",
                scheduleStillWorking: "No problem! Please let me know if you are 'done' or are 'still working on it' when you are ready to proceed.",
                scheduleHelp: "I'm sorry, I didn't understand. Please let me know if you are 'done' or are 'still working on it'.",
                generalFallback: "I'm sorry, I didn't quite understand what you meant. If you're having trouble typing, you can always choose an option from the buttons below.",
                formSending: "Sending...",
                formSent: "Message sent successfully! This window will close in 3 seconds...",
                formError: "Failed to send message. Please try again or contact Roger directly.",
                chatTitleMain: "Roger's AI Assistant",
                chatSubtitleMain: "Connecting you with Roger",
                inputPlaceholder: "Type your message...",
                profileAltText: "AI Assistant",
                generateDraft: "Draft Message",
                generatingDraft: "Generating...",
                draftGenerated: "Draft Generated!",
                rateExperience: "Please rate your experience:",
                thankYouForFeedback: "Thank You for your feedback!",
                watchVideo: "Certainly! Here's Roger's video for recruiters: <a href='https://vimeo.com/1090730386/4c50b956d0' target='_blank' rel='noopener noreferrer' class='video-link'>From Paper to Person</a>",
                viewResume: "Of course. Here is Roger's resume:<br><iframe src='https://drive.google.com/file/d/1dotyuwYDQ2fdn9JzmKlQPvWDYbElngWB/preview' class='resume-embed'></iframe>",
                linkedinMessage: "Great! Here's a link to Roger's LinkedIn profile: <a href='https://www.linkedin.com/in/meetrogergomes' target='_blank' rel='noopener noreferrer' class='linkedin-link'>linkedin.com/in/meetrogergomes</a>",
                exitButton: "Exit",
                creatorSignaturePrefix: "Created by",
                welcomeVideo: 'https://gomesroger.github.io/roger-ai-assets/Ai%20Assistant%20Video-%20ENG.webm',
                videoPlaybackError: "Video could not be played. Proceeding with text introduction."
            },
            ja: {
                welcome: "ğŸ‘‹ ã“ã‚“ã«ã¡ã¯ï¼ç§ã¯ãƒ­ã‚¸ãƒ£ãƒ¼ã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ãƒ­ã‚¸ãƒ£ãƒ¼ã¨ã¤ãªãŒã‚‹ãŠæ‰‹ä¼ã„ã‚’ã—ã¾ã™ã€‚",
                intro: "ä»¥ä¸‹ã®ã“ã¨ã‚’ãŠæ‰‹ä¼ã„ã§ãã¾ã™ï¼š\nâ€¢ ãƒãƒ£ãƒƒãƒˆã‚’äºˆç´„\nâ€¢ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ®‹ã™\nâ€¢ è·æ­´ãƒ»ã‚¹ã‚­ãƒ«æ¦‚è¦ã‚’ä½œæˆ\nâ€¢ ãƒ­ã‚¸ãƒ£ãƒ¼ã®ãƒ“ãƒ‡ã‚ªã‚’è¦‹ã‚‹\nâ€¢ å±¥æ­´æ›¸ã‚’è¦‹ã‚‹\nâ€¢ è·å‹™çµŒæ­´æ›¸ã‚’è¦‹ã‚‹\nâ€¢ LinkedInã§ã¤ãªãŒã‚‹",
                askName: "ã¾ãšã€ãŠåå‰ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚",
                askCompany: "{name}ã•ã‚“ã€ã¯ã˜ã‚ã¾ã—ã¦ï¼ã©ã¡ã‚‰ã®ä¼šç¤¾ã«ãŠå‹¤ã‚ã§ã™ã‹ï¼Ÿ",
                askPurpose: "{name}ã•ã‚“ã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼æœ¬æ—¥ã¯ã©ã®ã‚ˆã†ãªã”ç”¨ä»¶ã§ã—ã‚‡ã†ã‹ï¼Ÿ",
                professionalSummary: "ãƒ­ã‚¸ãƒ£ãƒ¼ãƒ»ã‚´ãƒ¡ã‚¹ã¯ã€APACãŠã‚ˆã³åŒ—ç±³åœ°åŸŸã«ãŠã‘ã‚‹B2B SaaSã€AIã€ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—äº‹æ¥­ã®ã‚¹ã‚±ãƒ¼ãƒ«æ”¯æ´ã«20å¹´ä»¥ä¸Šã®çµŒé¨“ã‚’æŒã¤ã€GTMæˆ¦ç•¥ãŠã‚ˆã³DXãƒªãƒ¼ãƒ€ãƒ¼ã§ã™ã€‚0â†’1ã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆç«‹ã¡ä¸Šã’ã€ã‚¯ãƒ­ã‚¹ãƒœãƒ¼ãƒ€ãƒ¼ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã€ãƒ‡ã‚¸ã‚¿ãƒ«ï¼ãƒ“ã‚¸ãƒã‚¹å¤‰é©ã‚’é€šã˜ã¦ã€æŒç¶šå¯èƒ½ãªæˆé•·ã¨æ¥­å‹™ã®æ©Ÿå‹•åŠ›ã‚’å®Ÿç¾ã—ã¦ãã¾ã—ãŸã€‚\n\nã“ã‚Œã¾ã§ã«ç·é¡3,300ä¸‡ãƒ‰ãƒ«è¶…ã®å›½éš›ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒªãƒ¼ãƒ‰ã—ã€æ—¥æœ¬ãƒ»ã‚¿ã‚¤ãƒ»ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢é–“ã§å¤šæ§˜ãªé–¢ä¿‚è€…ã‚’å††æ»‘ã«é€£æºã•ã›ã¦ãã¾ã—ãŸã€‚æ—¥æœ¬èªã¯æ—¥å¸¸ä¼šè©±ãƒ¬ãƒ™ãƒ«ï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ¬ãƒ™ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰ã§ã™ãŒã€å‰è·ã§ã¯æ—¥æœ¬äººã‚¹ã‚¿ãƒƒãƒ•16åä»¥ä¸Šã®ãƒãƒ¼ãƒ ã‚’Slackã€Teamsã€LINEã€Zoomã€AIãƒ„ãƒ¼ãƒ«ãªã©ã‚’æ´»ç”¨ã—ãªãŒã‚‰ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã—ã¦ãã¾ã—ãŸã€‚\n\nç¾åœ¨ã¯æ—¥æœ¬ã«åœ¨ä½ã—ã¦ãŠã‚Šã€ãƒ“ã‚¶æ”¯æ´ã¯ä¸è¦ã§ã™ã€‚å¼•ã£è¶Šã—ã«ã‚‚æŸ”è»Ÿã«å¯¾å¿œå¯èƒ½ã§ã€ã‚ªãƒ¼ãƒŠãƒ¼ã‚·ãƒƒãƒ—ã‚’é‡è¦–ã™ã‚‹ä¼æ¥­æ–‡åŒ–ã€ç¶™ç¶šçš„ãªå­¦ã³ã€ãã—ã¦ç¾å ´èª²é¡Œã®è§£æ±ºã«è²¢çŒ®ã§ãã‚‹ç’°å¢ƒã‚’å¤§åˆ‡ã«ã—ã¦ã„ã¾ã™ã€‚",
                afterRogerMessage: "ä»–ã«ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ\n\nãƒ­ã‚¸ãƒ£ãƒ¼ã¨ã®ãƒãƒ£ãƒƒãƒˆäºˆç´„ã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã¯ã€ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ãŠæ°—è»½ã«ã©ã†ãï¼",
                scheduleConfirm: "å®Œç’§ã§ã™ï¼ãƒ­ã‚¸ãƒ£ãƒ¼ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é–‹ãã¾ã™ã€‚æœ€é©ãªæ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚",
                scheduleFollowUp: "ãƒ­ã‚¸ãƒ£ãƒ¼ã¨ã®ã‚¢ãƒã‚¤ãƒ³ãƒˆãƒ¡ãƒ³ãƒˆã®äºˆç´„ã¯å®Œäº†ã—ã¾ã—ãŸã‹ï¼Ÿ",
                appointmentComplete: "ç´ æ™´ã‚‰ã—ã„ï¼ãƒ­ã‚¸ãƒ£ãƒ¼ãŒäºˆç´„ç¢ºèªã‚’å—ã‘å–ã‚Šã€ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®æº–å‚™ã‚’ã„ãŸã—ã¾ã™ã€‚ã”é€£çµ¡ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼",
                windowClosing: "ã“ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¯3ç§’å¾Œã«è‡ªå‹•çš„ã«é–‰ã˜ã¾ã™...",
                messagePrompt: "ãƒ­ã‚¸ãƒ£ãƒ¼ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãŠé€ã‚Šã™ã‚‹ãŠæ‰‹ä¼ã„ã‚’ã„ãŸã—ã¾ã™ã€‚ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒ ã«ã”è¨˜å…¥ãã ã•ã„ï¼š",
                goodbye: "ãŠæ™‚é–“ã‚’ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼ã„ã¤ã§ã‚‚ãŠæ°—è»½ã«ã”é€£çµ¡ãã ã•ã„ã€‚",
                scheduleStillWorking: "å•é¡Œã‚ã‚Šã¾ã›ã‚“ï¼ã€Œå®Œäº†ã—ã¾ã—ãŸã€ã¾ãŸã¯ã€Œã¾ã ä½œæ¥­ä¸­ã§ã™ã€ã®ã©ã¡ã‚‰ã‹ã§ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚",
                scheduleHelp: "ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€ç†è§£ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã€Œå®Œäº†ã—ã¾ã—ãŸã€ã¾ãŸã¯ã€Œã¾ã ä½œæ¥­ä¸­ã§ã™ã€ã®ã©ã¡ã‚‰ã‹ã§ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚",
                generalFallback: "ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€ãŠã£ã—ã‚ƒã£ã¦ã„ã‚‹æ„å‘³ãŒã‚ˆãåˆ†ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã—å…¥åŠ›ã§ãŠå›°ã‚Šã§ã—ãŸã‚‰ã€ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚",
                formSending: "é€ä¿¡ä¸­...",
                formSent: "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ­£å¸¸ã«é€ä¿¡ã•ã‚Œã¾ã—ãŸï¼ã“ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¯3ç§’å¾Œã«é–‰ã˜ã¾ã™...",
                formError: "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ã„ãŸã ãã‹ã€ç›´æ¥ãƒ­ã‚¸ãƒ£ãƒ¼ã«ã”é€£çµ¡ãã ã•ã„ã€‚",
                chatTitleMain: "Roger's AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ",
                chatSubtitleMain: "ãƒ­ã‚¸ãƒ£ãƒ¼ã¨ã®ã”é€£çµ¡ã‚’ãŠæ‰‹ä¼ã„ã—ã¾ã™",
                inputPlaceholder: "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...",
                profileAltText: "AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ",
                generateDraft: "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸‹æ›¸ãç”Ÿæˆ",
                generatingDraft: "ç”Ÿæˆä¸­...",
                draftGenerated: "ä¸‹æ›¸ãã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼",
                rateExperience: "ä½“é¨“ã¯ã„ã‹ãŒã§ã—ãŸã‹ï¼Ÿ",
                thankYouForFeedback: "ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼",
                watchVideo: "ã¯ã„ã€æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚æ¡ç”¨æ‹…å½“è€…å‘ã‘ã®ãƒ­ã‚¸ãƒ£ãƒ¼ã®ãƒ“ãƒ‡ã‚ªã¯ã“ã¡ã‚‰ã§ã™ï¼š<a href='https://vimeo.com/1090731598/b065f49f38' target='_blank' rel='noopener noreferrer' class='video-link'>ç°¡å˜ãªã”æŒ¨æ‹¶</a>",
                viewRirekisho: "ã¯ã„ã€æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚ãƒ­ã‚¸ãƒ£ãƒ¼ã®å±¥æ­´æ›¸ã§ã™ï¼š<br><iframe src='https://drive.google.com/file/d/1xCcKF-MIK3BRbHdWX_j7B6u1qjJ_osrX/preview' class='resume-embed'></iframe>",
                viewShokumuKeirekisho: "ã¯ã„ã€æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚ãƒ­ã‚¸ãƒ£ãƒ¼ã®è·å‹™çµŒæ­´æ›¸ã§ã™ï¼š<br><iframe src='https://drive.google.com/file/d/1jRdu6uPBrGKT0ctRrdmGWLW_-QI52fJj/preview' class='resume-embed'></iframe>",
                linkedinMessage: "ã¯ã„ã€æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚ãƒ­ã‚¸ãƒ£ãƒ¼ã®LinkedInãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¯ã“ã¡ã‚‰ã§ã™ï¼š<a href='https://www.linkedin.com/in/meetrogergomes' target='_blank' rel='noopener noreferrer' class='linkedin-link'>linkedin.com/in/meetrogergomes</a>",
                exitButton: "çµ‚äº†",
                creatorSignaturePrefix: "ä½œæˆè€…ï¼š",
                welcomeVideo: 'https://gomesroger.github.io/roger-ai-assets/Ai%20Assistant%20Video-%20JPN.webm', 
                videoPlaybackError: "å‹•ç”»ã‚’å†ç”Ÿã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ†ã‚­ã‚¹ãƒˆã§ã®å°å…¥ã«é€²ã¿ã¾ã™ã€‚"
            }
        };

        const quickRepliesData = {
            en: {
                start: ["Schedule a chat", "Leave a message", "Generate Professional Summary", "Watch Roger's Video", "View Resume", "Connect on LinkedIn", "Exit"],
                purpose: ["Schedule a chat", "Leave a message", "Generate Professional Summary", "Watch Roger's Video", "View Resume", "Connect on LinkedIn", "Exit"],
                scheduleConfirm: ["Yes, I'm done", "Still working on it"],
            },
            ja: {
                start: ["ãƒãƒ£ãƒƒãƒˆã‚’äºˆç´„", "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ®‹ã™", "è·æ­´ãƒ»ã‚¹ã‚­ãƒ«æ¦‚è¦ã‚’ä½œæˆ", "ãƒ­ã‚¸ãƒ£ãƒ¼ã®ãƒ“ãƒ‡ã‚ªã‚’è¦‹ã‚‹", "å±¥æ­´æ›¸ã‚’è¦‹ã‚‹", "è·å‹™çµŒæ­´æ›¸ã‚’è¦‹ã‚‹", "LinkedInã§ã¤ãªãŒã‚‹", "çµ‚äº†"],
                purpose: ["ãƒãƒ£ãƒƒãƒˆã‚’äºˆç´„", "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ®‹ã™", "è·æ­´ãƒ»ã‚¹ã‚­ãƒ«æ¦‚è¦ã‚’ä½œæˆ", "ãƒ­ã‚¸ãƒ£ãƒ¼ã®ãƒ“ãƒ‡ã‚ªã‚’è¦‹ã‚‹", "å±¥æ­´æ›¸ã‚’è¦‹ã‚‹", "è·å‹™çµŒæ­´æ›¸ã‚’è¦‹ã‚‹", "LinkedInã§ã¤ãªãŒã‚‹", "çµ‚äº†"],
                scheduleConfirm: ["ã¯ã„ã€å®Œäº†ã—ã¾ã—ãŸ", "ã¾ã ä½œæ¥­ä¸­ã§ã™"],
            }
        };

        const formLabelsData = {
            en: {
                name: "Your Name:",
                company: "Company:",
                email: "Email:",
                message: "Message for Roger:",
                submit: "Send Message"
            },
            ja: {
                name: "ãŠåå‰:",
                company: "ä¼šç¤¾å:",
                email: "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:",
                message: "ãƒ­ã‚¸ãƒ£ãƒ¼ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:",
                submit: "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡"
            }
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            cacheDOMElements();
            initializeEventListeners();
            // Initially, only show the language selection screen
            languageSelectionScreen.style.display = 'flex';
            chatContainer.style.display = 'none'; // Ensure chat is hidden
        });

        /**
         * Caches references to frequently used DOM elements.
         */
        function cacheDOMElements() {
            languageSelectionScreen = document.getElementById('languageSelectionScreen');
            englishButton = document.querySelector('.language-button.english');
            japaneseButton = document.querySelector('.language-button.japanese');
            chatContainer = document.getElementById('chatContainer');

            chatMessagesContainer = document.getElementById('chatMessages');
            chatInput = document.getElementById('chatInput');
            sendButton = document.getElementById('sendBtn');
            quickRepliesContainer = document.getElementById('quickReplies');
            chatInputContainer = document.getElementById('chatInputContainer');
            messageForm = document.getElementById('messageForm');
            nameLabel = document.getElementById('nameLabel');
            companyLabel = document.getElementById('companyLabel');
            emailLabel = document.getElementById('emailLabel');
            messageLabel = document.getElementById('messageLabel');
            submitBtn = document.getElementById('submitBtn');
            closeNotice = document.getElementById('closeNotice');
            chatTitleElement = document.querySelector('.chat-title');
            chatSubtitleElement = document.querySelector('.chat-subtitle');
            profilePicImg = document.querySelector('.profile-pic img');
            avatarFallback = document.getElementById('avatarFallback');
            generateDraftButton = document.getElementById('generateDraftBtn');
            generateDraftButtonText = document.getElementById('generateDraftBtnText');
            chatRatingContainer = document.getElementById('chatRatingContainer');
            ratingPrompt = document.getElementById('ratingPrompt');
            starRatingContainer = document.getElementById('starRating');
            ratingThankYou = document.getElementById('ratingThankYou');
            closeNoticeText = document.getElementById('closeNoticeText');
            creatorSignatureElement = document.getElementById('creatorSignature');
            welcomeVideoPlayer = document.getElementById('welcomeVideoPlayer');
            chatHeaderElement = document.querySelector('.chat-header');
        }

        /**
         * Initializes all necessary event listeners for interactive elements.
         */
        function initializeEventListeners() {
            englishButton.addEventListener('click', () => selectLanguage('en'));
            japaneseButton.addEventListener('click', () => selectLanguage('ja'));

            chatInput.addEventListener('input', autoResizeTextarea);
            chatInput.addEventListener('keydown', handleInputKeydown);
            sendButton.addEventListener('click', sendMessage);
            document.querySelector('#messageForm form').addEventListener('submit', submitMessageForm);
            generateDraftButton.addEventListener('click', generateMessageDraft);
            starRatingContainer.addEventListener('click', handleStarRatingClick);
            starRatingContainer.addEventListener('mouseover', handleStarRatingHover);
            starRatingContainer.addEventListener('mouseout', handleStarRatingOut);
        }

        /**
         * Handles language selection from the initial screen.
         */
        function selectLanguage(lang) {
            console.log(`Language selected: ${lang}`);
            currentLanguage = lang;
            languageSelectionScreen.style.display = 'none';
            chatContainer.style.display = 'flex'; // Show the chat container
            updateUIForLanguage();
            startConversation(); // Start the chat flow with the chosen language's video
        }

        /**
         * Automatically adjusts the height of the textarea based on its content.
         */
        function autoResizeTextarea() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        }

        /**
         * Handles keydown events in the chat input, specifically for sending messages with Enter.
         */
        function handleInputKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        // --- Core Chat Logic ---

        /**
         * Starts or restarts the conversation flow.
         */
        function startConversation() {
            console.log("startConversation called. Resetting state.");
            conversationStep = 0;
            userInfo = {};
            waitingForScheduleConfirmation = false;
            isTyping = false;
            isLeavingMessageDirectly = false;
            directMessageSubStep = 0;

            chatMessagesContainer.innerHTML = '';
            hideQuickReplies();
            chatInputContainer.classList.remove('hidden');
            messageForm.classList.add('hidden');
            closeNotice.classList.add('hidden');
            chatRatingContainer.classList.add('hidden');
            resetStars();

            chatHeaderElement.classList.remove('video-active');

            // Play the welcome video first after language selection
            playWelcomeVideo();
        }

        /**
         * Plays the welcome video based on the current language.
         * Transitions to text introduction after video ends or fails to autoplay.
         */
        function playWelcomeVideo() {
            if (!welcomeVideoPlayer) {
                console.error("playWelcomeVideo: Welcome video player element not found. Skipping video playback.");
                startTextIntroduction();
                return;
            }

            const videoSrc = messages[currentLanguage].welcomeVideo;
            console.log(`playWelcomeVideo: Attempting to play video for language: ${currentLanguage}, source: ${videoSrc}`);

            if (!videoSrc) {
                console.warn(`playWelcomeVideo: No video source defined for language ${currentLanguage}. Proceeding with text introduction.`);
                chatHeaderElement.classList.remove('video-active'); // Ensure header is visible
                startTextIntroduction();
                return;
            }

            // Reset video state for new playback attempt
            welcomeVideoPlayer.classList.remove('visible');
            chatHeaderElement.classList.add('video-active'); // Hide static header elements while video attempts to play
            welcomeVideoPlayer.src = videoSrc; // Set new video source
            welcomeVideoPlayer.load(); // Load the new source

            // Event listener for video errors
            welcomeVideoPlayer.onerror = (e) => {
                console.error("playWelcomeVideo: Video error occurred:", e);
                welcomeVideoPlayer.classList.remove('visible');
                chatHeaderElement.classList.remove('video-active'); // Show static header elements on error
                // Display user-friendly message in chat
                addBotMessage(messages[currentLanguage].videoPlaybackError, false); // No typing effect for this instant message
                startTextIntroduction(); // Fallback to text on error
            };

            // Event listener for when video can play without interruption
            welcomeVideoPlayer.oncanplaythrough = () => {
                console.log(`playWelcomeVideo: Video canplaythrough for: ${welcomeVideoPlayer.src}. Attempting to play.`);
                welcomeVideoPlayer.classList.add('visible'); // Make video visible
                welcomeVideoPlayer.play().then(() => {
                    console.log(`playWelcomeVideo: Video started playing successfully: ${welcomeVideoPlayer.src}`);
                }).catch(error => {
                    console.warn("playWelcomeVideo: Video autoplay prevented (likely due to sound/browser policy):", error);
                    welcomeVideoPlayer.classList.remove('visible');
                    chatHeaderElement.classList.remove('video-active'); // Show static header elements if autoplay blocked
                    // Display user-friendly message in chat
                    addBotMessage(messages[currentLanguage].videoPlaybackError, false); // No typing effect for this instant message
                    startTextIntroduction(); // Fallback to text if autoplay blocked
                });
            };

            // Event listener for when the video finishes playing
            welcomeVideoPlayer.onended = () => {
                console.log(`playWelcomeVideo: Video ended: ${welcomeVideoPlayer.src}`);
                welcomeVideoPlayer.classList.remove('visible'); // Hide video after it ends
                chatHeaderElement.classList.remove('video-active'); // Show static header elements after video ends
                startTextIntroduction(); // Proceed with chat introduction messages
            };

            // Safety net timeout in case 'oncanplaythrough' or 'play()' promise don't resolve as expected
            setTimeout(() => {
                if (!welcomeVideoPlayer.classList.contains('visible') && !welcomeVideoPlayer.ended && !welcomeVideoPlayer.paused) {
                    console.warn("playWelcomeVideo: Video did not start playing as expected within timeout, or was still attempting. Proceeding with text introduction.");
                    welcomeVideoPlayer.classList.remove('visible');
                    chatHeaderElement.classList.remove('video-active');
                    // Display user-friendly message in chat
                    addBotMessage(messages[currentLanguage].videoPlaybackError, false); // No typing effect for this instant message
                    startTextIntroduction();
                }
            }, 4000); // Give the video 4 seconds to start
        }

        /**
         * Initiates the text-based welcome messages after video playback.
         */
        function startTextIntroduction() {
            console.log("startTextIntroduction called.");
            setTimeout(async () => {
                await addBotMessage(messages[currentLanguage].welcome);
                setTimeout(async () => {
                    await addBotMessage(messages[currentLanguage].intro);
                    showQuickReplies('start');
                }, 1500);
            }, 1000);
        }

        /**
         * Appends a message to the chat display.
         */
        function addMessageToDOM(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            const formattedText = text.replace(/\n/g, '<br>');
            messageDiv.innerHTML = formattedText;

            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            messageDiv.appendChild(timeDiv);

            chatMessagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        /**
         * Adds a bot message to the chat, optionally with a typing indicator.
         */
        function addBotMessage(text, showTypingEffect = true) {
            return new Promise(resolve => {
                if (showTypingEffect) {
                    showTypingIndicator();
                    const typingTime = Math.min(text.length * 30, 2000);
                    setTimeout(() => {
                        hideTypingIndicator();
                        addMessageToDOM(text, 'bot');
                        resolve();
                    }, typingTime);
                } else {
                    addMessageToDOM(text, 'bot');
                    resolve();
                }
            });
        }

        /**
         * Displays a typing indicator in the chat.
         */
        function showTypingIndicator() {
            if (isTyping) return;
            isTyping = true;
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `<div class="typing-dots"><span></span><span></span><span></span></div>`;
            chatMessagesContainer.appendChild(typingDiv);
            scrollToBottom();
        }

        /**
         * Hides the typing indicator from the chat.
         */
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
            isTyping = false;
        }

        /**
         * Sends a user message.
         */
        function sendMessage() {
            const messageText = chatInput.value.trim();
            if (!messageText || isTyping) return;

            addMessageToDOM(messageText, 'user');
            chatInput.value = '';
            autoResizeTextarea.call(chatInput);
            hideQuickReplies();
            disableInput();

            processUserMessage(messageText);
        }

        /**
         * Initiates the direct message leaving flow.
         */
        async function initiateDirectMessage() {
            console.log("initiateDirectMessage called.");
            isLeavingMessageDirectly = true;
            directMessageSubStep = 1;
            await addBotMessage(messages[currentLanguage].askName);
            enableInput();
        }

        /**
         * REFACTORED: Processes the user's message with a clearer, prioritized logic.
         */
        async function processUserMessage(message) {
            console.log("processUserMessage called. Message:", message);
            await delay(500);

            const lowerMessage = message.toLowerCase();
            const lang = currentLanguage;

            // --- 1. State-based conversation flows (take priority over new intents) ---
            if (isLeavingMessageDirectly) {
                if (directMessageSubStep === 1) {
                    userInfo.name = message;
                    await addBotMessage(messages[lang].askCompany.replace('{name}', userInfo.name || (lang === 'en' ? 'there' : 'çš†æ§˜')));
                    directMessageSubStep = 2;
                } else if (directMessageSubStep === 2) {
                    userInfo.company = message;
                    await addBotMessage(messages[lang].messagePrompt);
                    await delay(1500);
                    showMessageForm();
                    isLeavingMessageDirectly = false; // End of this sub-flow
                    directMessageSubStep = 0;
                    conversationStep = 99; // Paused state (form is open)
                }
                enableInput();
                return;
            }

            if (waitingForScheduleConfirmation) {
                await handleScheduleFollowUp(message);
                enableInput();
                return;
            }

            // --- 2. Top-level commands and new intent matching ---
            
            // Exit command
            const exitIntent = lang === 'ja' ? quickRepliesData.ja.start[7] : quickRepliesData.en.start[6];
            const exitKeywords = ["quit", "end chat", "ã‚„ã‚ã‚‹", "ä¼šè©±ã‚’çµ‚äº†", "bye", "ã•ã‚ˆã†ãªã‚‰"];
            if (exitKeywords.some(keyword => lowerMessage.includes(keyword)) || lowerMessage === exitIntent.toLowerCase()) {
                await addBotMessage(messages[lang].goodbye);
                await delay(2000);
                showRatingPrompt();
                enableInput();
                conversationStep = 100; // End state
                return;
            }
            
            // --- 3. Intent Matching & Flow Control (New, safer structure) ---
            
            // Schedule a Chat (Direct action, then follow-up)
            if (lowerMessage.includes("schedule a chat") || lowerMessage.includes("ãƒãƒ£ãƒƒãƒˆã‚’äºˆç´„") || lowerMessage === quickRepliesData[lang].start[0].toLowerCase()) {
                await addBotMessage(messages[lang].scheduleConfirm);
                window.open('https://calendly.com/gomes-roger333', '_blank');
                setTimeout(async () => {
                    waitingForScheduleConfirmation = true;
                    await addBotMessage(messages[lang].scheduleFollowUp);
                    showQuickReplies('scheduleConfirm');
                    enableInput();
                }, 2000);
                return;
            } 
            // Leave a Message (starts a multi-step flow)
            else if (lowerMessage.includes("leave a message") || lowerMessage.includes("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ®‹ã™") || lowerMessage === quickRepliesData[lang].start[1].toLowerCase()) {
                initiateDirectMessage();
                return; 
            }
            // All other intents are one-off and will be followed by the "after" message.
            else {
                let informationalIntentReply = null;
                
                // Japanese Resume Intents (checked first for specificity)
                if (lang === 'ja' && (lowerMessage.includes("å±¥æ­´æ›¸") || lowerMessage === quickRepliesData.ja.start[4].toLowerCase())) {
                    informationalIntentReply = messages.ja.viewRirekisho;
                } else if (lang === 'ja' && (lowerMessage.includes("è·å‹™çµŒæ­´æ›¸") || lowerMessage === quickRepliesData.ja.start[5].toLowerCase())) {
                    informationalIntentReply = messages.ja.viewShokumuKeirekisho;
                } 
                // English Resume Intent
                else if (lang === 'en' && (lowerMessage.includes("resume") || lowerMessage === quickRepliesData.en.start[4].toLowerCase())) {
                    informationalIntentReply = messages.en.viewResume;
                } 
                // Video Intent
                else if (lowerMessage.includes("video") || lowerMessage.includes("ãƒ“ãƒ‡ã‚ª") || lowerMessage.includes("è¦‹ã‚‹") || lowerMessage === quickRepliesData[lang].start[3].toLowerCase()) {
                    informationalIntentReply = messages[lang].watchVideo;
                } 
                // Greeting Intent / Professional Summary
                else if (lowerMessage.includes("summary") || lowerMessage.includes("æ¦‚è¦") || lowerMessage === quickRepliesData[lang].start[2].toLowerCase()) {
                    informationalIntentReply = messages[lang].professionalSummary;
                }
                // LinkedIn Intent
                const linkedinIndex = lang === 'ja' ? 6 : 5;
                if (!informationalIntentReply && (lowerMessage.includes("linkedin") || lowerMessage === quickRepliesData[lang].start[linkedinIndex].toLowerCase())) {
                    informationalIntentReply = messages[lang].linkedinMessage;
                }

                // If any informational intent was matched, show the info and then the follow-up.
                if (informationalIntentReply) {
                    await addBotMessage(informationalIntentReply);
                    await delay(2500);
                    await addBotMessage(messages[lang].afterRogerMessage);
                    showQuickReplies('purpose');
                    enableInput();
                    conversationStep = 99;
                } else {
                    // Fallback if no intent matches at all
                    await addBotMessage(messages[currentLanguage].generalFallback);
                    showQuickReplies('start');
                    conversationStep = 0;
                    enableInput();
                }
            }
        }

        async function handleScheduleFollowUp(message) {
            console.log("handleScheduleFollowUp called. Message:", message);
            const lowerMessage = message.toLowerCase();
            const lang = currentLanguage;

            if (lowerMessage.includes(quickRepliesData[lang].scheduleConfirm[0].toLowerCase()) || lowerMessage.includes("yes") || lowerMessage.includes("ã¯ã„")) {
                await addBotMessage(messages[lang].appointmentComplete);
                await delay(2000);
                showRatingPrompt();
                waitingForScheduleConfirmation = false;
            }
            else if (lowerMessage.includes(quickRepliesData[lang].scheduleConfirm[1].toLowerCase()) || lowerMessage.includes("still") || lowerMessage.includes("ã¾ã ")) {
                await addBotMessage(messages[lang].scheduleStillWorking);
                showQuickReplies('scheduleConfirm');
                waitingForScheduleConfirmation = true;
            }
            else {
                await addBotMessage(messages[lang].scheduleHelp);
                showQuickReplies('scheduleConfirm');
                waitingForScheduleConfirmation = true;
            }
        }

        // --- UI Updates & Interactions ---

        function showMessageForm() {
            console.log("showMessageForm called.");
            chatInputContainer.classList.add('hidden');
            quickRepliesContainer.classList.add('hidden');
            messageForm.classList.remove('hidden');
            chatRatingContainer.classList.add('hidden');
            resetStars();
            updateFormLabels();
            if (userInfo.name) document.getElementById('formName').value = userInfo.name;
            if (userInfo.company) document.getElementById('formCompany').value = userInfo.company;
            document.getElementById('formEmail').focus();
            document.getElementById('formMessage').value = '';
        }

        function updateFormLabels() {
            const labels = formLabelsData[currentLanguage];
            nameLabel.textContent = labels.name;
            companyLabel.textContent = labels.company;
            emailLabel.textContent = labels.email;
            messageLabel.textContent = labels.message;
            submitBtn.textContent = labels.submit;
            generateDraftButtonText.textContent = messages[currentLanguage].generateDraft;
        }

        async function submitMessageForm(event) {
            event.preventDefault();
            console.log("submitMessageForm called.");

            const formData = {
                name: document.getElementById('formName').value,
                company: document.getElementById('formCompany').value,
                email: document.getElementById('formEmail').value,
                message: document.getElementById('formMessage').value
            };

            submitBtn.disabled = true;
            generateDraftButton.disabled = true;
            submitBtn.textContent = messages[currentLanguage].formSending;
            closeNotice.classList.remove('hidden');
            closeNoticeText.textContent = messages[currentLanguage].formSending;

            console.log("Form data to be sent:", formData);

            try {
                if (GOOGLE_APPS_SCRIPT_WEB_APP_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE' || !GOOGLE_APPS_SCRIPT_WEB_APP_URL.startsWith('https://script.google.com/macros/s/')) {
                    throw new Error("Google Apps Script Web App URL is not configured correctly. Please update the GOOGLE_APPS_SCRIPT_WEB_APP_URL constant in the script.");
                }

                const response = await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData),
                });

                console.log("Response from Apps Script (due to no-cors, cannot read body):", response);
                closeNoticeText.textContent = messages[currentLanguage].formSent;

                await delay(1500); // Wait for user to read the notice
                showRatingPrompt();

            } catch (error) {
                console.error("Error sending message to Apps Script:", error);
                closeNoticeText.textContent = messages[currentLanguage].formError;
                // Re-enable buttons on failure
                submitBtn.disabled = false;
                generateDraftButton.disabled = false;
                submitBtn.textContent = formLabelsData[currentLanguage].submit;
            }
        }

        async function generateMessageDraft() {
            console.log("generateMessageDraft called.");
            const formMessageInput = document.getElementById('formMessage');
            const userIntent = formMessageInput.value.trim();
            const userName = document.getElementById('formName').value.trim();
            const userCompany = document.getElementById('formCompany').value.trim();

            if (!userIntent) {
                formMessageInput.value = "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ„å›³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n(Please enter your message intent.)";
                return;
            }

            generateDraftButton.disabled = true;
            generateDraftButtonText.textContent = messages[currentLanguage].generatingDraft;
            generateDraftButton.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                let prompt;
                if (currentLanguage === 'en') {
                    prompt = `Draft a professional email/message to Roger. The user's name is "${userName}", their company is "${userCompany}". Their message intent is: "${userIntent}". Ensure the draft is concise, professional, and clearly conveys the user's purpose.`;
                } else {
                    prompt = `ãƒ­ã‚¸ãƒ£ãƒ¼ã¸ã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ¡ãƒ¼ãƒ«/ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¸‹æ›¸ãã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå‰ã¯ã€Œ${userName}ã€ã€ä¼šç¤¾ã¯ã€Œ${userCompany}ã€ã§ã™ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ„å›³ã¯ã€Œ${userIntent}ã€ã§ã™ã€‚ä¸‹æ›¸ãã¯ç°¡æ½”ã§ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§ã‚ã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç›®çš„ã‚’æ˜ç¢ºã«ä¼ãˆã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚`;
                }
                
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "" 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    formMessageInput.value = text;
                    generateDraftButtonText.textContent = messages[currentLanguage].draftGenerated;
                } else {
                    formMessageInput.value = messages[currentLanguage].generalFallback;
                }
            } catch (error) {
                console.error("Error generating message draft:", error);
                formMessageInput.value = "ä¸‹æ›¸ãã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n(Error generating draft.)";
            } finally {
                generateDraftButton.disabled = false;
                generateDraftButton.classList.remove('opacity-50', 'cursor-not-allowed');
                setTimeout(() => {
                    generateDraftButtonText.textContent = messages[currentLanguage].generateDraft;
                }, 2000);
                autoResizeTextarea.call(formMessageInput);
            }
        }

        function showQuickReplies(type) {
            console.log("showQuickReplies called. Type:", type);
            quickRepliesContainer.innerHTML = '';
            quickRepliesContainer.dataset.replyType = type;
            const replies = quickRepliesData[currentLanguage][type];

            if (replies) {
                replies.forEach(reply => {
                    const button = document.createElement('button');
                    button.className = 'quick-reply';
                    button.textContent = reply;
                    button.onclick = () => handleQuickReply(reply);
                    quickRepliesContainer.appendChild(button);
                });
                quickRepliesContainer.classList.remove('hidden');
                scrollToBottom();
            }
        }

        function handleQuickReply(replyText) {
            console.log("handleQuickReply called. Reply Text:", replyText);
            addMessageToDOM(replyText, 'user');
            hideQuickReplies();
            disableInput();
            processUserMessage(replyText);
        }

        function hideQuickReplies() {
            quickRepliesContainer.classList.add('hidden');
        }

        function disableInput() {
            chatInput.disabled = true;
            sendButton.disabled = true;
        }

        function enableInput() {
            chatInput.disabled = false;
            sendButton.disabled = false;
            chatInput.focus();
        }

        function scrollToBottom() {
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        function updateUIForLanguage() {
            chatTitleElement.textContent = messages[currentLanguage].chatTitleMain;
            chatSubtitleElement.textContent = messages[currentLanguage].chatSubtitleMain;
            chatInput.placeholder = messages[currentLanguage].inputPlaceholder;
            profilePicImg.alt = messages[currentLanguage].profileAltText;
            updateFormLabels();
            ratingPrompt.textContent = messages[currentLanguage].rateExperience;
            ratingThankYou.textContent = messages[currentLanguage].thankYouForFeedback;
            creatorSignatureElement.textContent = messages[currentLanguage].creatorSignaturePrefix + " Roger Gomes";
        }

        function showRatingPrompt() {
            console.log("showRatingPrompt called.");
            chatInputContainer.classList.add('hidden');
            messageForm.classList.add('hidden');
            quickRepliesContainer.classList.add('hidden');
            chatRatingContainer.classList.remove('hidden');
            ratingPrompt.textContent = messages[currentLanguage].rateExperience;
            ratingThankYou.classList.add('hidden');
            resetStars();
            scrollToBottom();
        }

        async function handleStarRatingClick(event) {
            console.log("handleStarRatingClick called.");
            const clickedStar = event.target.closest('.star');
            if (clickedStar) {
                const rating = parseInt(clickedStar.dataset.value);
                console.log("User rated:", rating, "stars");
                const stars = Array.from(starRatingContainer.children);
                stars.forEach(star => {
                    if (parseInt(star.dataset.value) <= rating) {
                        star.classList.add('selected');
                    } else {
                        star.classList.remove('selected');
                    }
                });

                ratingThankYou.textContent = messages[currentLanguage].thankYouForFeedback;
                ratingThankYou.classList.remove('hidden');

                starRatingContainer.style.pointerEvents = 'none';

                setTimeout(async () => {
                    // Hide the main chat container
                    chatContainer.style.display = 'none';

                    // Create and style the final closing message
                    const finalMessageContainer = document.createElement('div');
                    finalMessageContainer.style.textAlign = 'center';
                    finalMessageContainer.style.color = 'white';
                    finalMessageContainer.style.fontSize = '1.2em';
                    finalMessageContainer.style.padding = '40px';
                    finalMessageContainer.style.maxWidth = '600px';
                    finalMessageContainer.style.background = 'rgba(0, 0, 0, 0.2)';
                    finalMessageContainer.style.borderRadius = '20px';
                    finalMessageContainer.style.backdropFilter = 'blur(10px)';
                    finalMessageContainer.style.animation = 'slideUp 0.6s ease-out';
                    finalMessageContainer.innerHTML = `
                        <p style="margin-bottom: 1.5em;">Thatâ€™s a wrap for today! I hope Rogerâ€™s AI Assistant was helpful. Until next time! You can go ahead and close this window now.</p>
                        <p>ä»Šæ—¥ã¯ã“ã“ã¾ã§ã§ã™ï¼Rogerã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãŒãŠå½¹ã«ç«‹ã¦ã¦ã„ãŸã‚‰å¬‰ã—ã„ã§ã™ã€‚<br>ã¾ãŸãŠä¼šã„ã—ã¾ã—ã‚‡ã†ï¼ã“ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¯é–‰ã˜ã¦ã„ãŸã ã„ã¦å¤§ä¸ˆå¤«ã§ã™ã€‚</p>
                    `;
                    
                    // Append the final message to the body
                    document.body.appendChild(finalMessageContainer);

                }, 2000); // A 2-second delay after the "Thank you" message
            }
        }

        function handleStarRatingHover(event) {
            const hoveredStar = event.target.closest('.star');
            if (hoveredStar && starRatingContainer.style.pointerEvents !== 'none') {
                const hoverValue = parseInt(hoveredStar.dataset.value);
                const stars = Array.from(starRatingContainer.children);
                stars.forEach(star => {
                    if (parseInt(star.dataset.value) <= hoverValue) {
                        star.classList.add('selected');
                    } else {
                        star.classList.remove('selected');
                    }
                });
            }
        }

        function handleStarRatingOut(event) {
            if (starRatingContainer.style.pointerEvents !== 'none') {
                resetStars();
            }
        }

        function resetStars() {
            const stars = Array.from(starRatingContainer.children);
            stars.forEach(star => star.classList.remove('selected'));
            starRatingContainer.style.pointerEvents = 'auto';
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
