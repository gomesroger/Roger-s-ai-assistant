<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roger's AI Assistant / ãƒ­ã‚¸ãƒ£ãƒ¼ã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</title>
    <style>
        /* General Reset and Body Styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* Chat Container Styling */
        .chat-container {
            max-width: 450px;
            width: 100%;
            min-height: 600px; /* Changed from height to min-height */
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden; /* This hides content that overflows the main container */
            animation: slideUp 0.6s ease-out;
        }

        /* Chat Header Styling */
        .chat-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 20px 20px 0 0;
            position: relative; /* For language toggle positioning */
        }
        .profile-pic {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 10px;
            border: 3px solid white;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .profile-pic img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        .profile-pic .avatar-fallback {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            border-radius: 50%;
        }
        .chat-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .chat-subtitle {
            font-size: 12px;
            opacity: 0.9;
        }

        /* Chat Messages Area */
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto; /* Allows scrolling for chat messages */
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            animation: messageSlide 0.3s ease-out;
        }
        .message.bot {
            background: #f0f0f0;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .message.user {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: #f0f0f0;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            max-width: 80px;
            align-self: flex-start;
        }
        .typing-dots {
            display: flex;
            gap: 3px;
        }
        .typing-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #999;
            animation: typing 1.4s infinite;
        }
        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        /* Chat Input Area */
        .chat-input-container {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            background: white;
            border-radius: 0 0 20px 20px;
        }
        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end; /* Aligns textarea and button nicely if textarea grows */
        }
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            font-size: 14px;
            resize: none;
            max-height: 100px; /* Max height before scrolling */
            min-height: 40px; /* Consistent initial height with button */
            line-height: 1.4; /* Improved text readability */
            font-family: inherit;
            transition: border-color 0.2s ease-in-out; /* Smooth focus transition */
        }
        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }
        .send-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, background-color 0.2s;
        }
        .send-btn:hover {
            transform: scale(1.1);
        }
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background: #ccc; /* Clearer disabled state */
        }

        /* Quick Replies */
        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .quick-reply {
            padding: 8px 12px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-reply:hover {
            background: #667eea;
            color: white;
        }

        /* Message Form Styles */
        .message-form {
            flex: 1; /* Allow form to take available space */
            padding: 20px;
            background: white;
            border-radius: 0 0 20px 20px; /* Match chat container */
            border-top: 1px solid #e0e0e0;
            overflow-y: auto; /* Allows scrolling within the form itself */
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s ease-in-out;
        }
        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }
        .form-submit-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .form-submit {
            flex: 1;
            padding: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
        }
        .form-submit:hover {
            transform: translateY(-2px);
        }
        .form-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            background: #ccc; /* Clearer disabled state */
        }
        .generate-draft-btn {
            flex: 1;
            padding: 12px;
            background: #f0f0f0;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .generate-draft-btn:hover {
            transform: translateY(-2px);
            background: #e0e0e0;
        }
        .generate-draft-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            background: #ccc; /* Clearer disabled state */
            color: #666;
            border-color: #999;
        }

        /* Animations */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-8px);
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        /* Scrollbar Styling */
        .chat-messages::-webkit-scrollbar,
        .message-form::-webkit-scrollbar { /* Added scrollbar for message-form */
            width: 4px;
        }
        .chat-messages::-webkit-scrollbar-track,
        .message-form::-webkit-scrollbar-track { /* Added scrollbar track for message-form */
            background: transparent;
        }
        .chat-messages::-webkit-scrollbar-thumb,
        .message-form::-webkit-scrollbar-thumb { /* Added scrollbar thumb for message-form */
            background: #ccc;
            border-radius: 2px;
        }

        /* Language Toggle Button */
        .language-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            z-index: 10; /* Ensure it's above other header content */
        }

        /* Message Timestamp */
        .message-time {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 4px;
            text-align: right; /* Align time to the right of the message bubble */
        }
        .message.bot .message-time {
            text-align: left; /* Align time to the left for bot messages */
        }

        /* Close Notice (for form submission success) */
        .close-notice {
            background: #e8f5e8;
            color: #2d5a2d;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 12px;
            text-align: center;
            display: flex; /* Use flexbox for alignment */
            flex-direction: column; /* Stack content vertically */
            gap: 10px; /* Space between elements */
        }

        .close-notice .email-content-display {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            padding: 10px;
            border-radius: 5px;
            text-align: left;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            word-break: break-word; /* Break long words */
            max-height: 150px; /* Limit height */
            overflow-y: auto; /* Add scroll if content overflows */
        }

        .close-notice .copy-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .close-notice .copy-btn:hover {
            background: #764ba2;
        }

        /* Star Rating Styles */
        .chat-rating-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            border-radius: 0 0 20px 20px;
        }
        .rating-prompt {
            font-size: 14px;
            color: #333;
            margin-bottom: 10px;
        }
        .stars {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 10px;
        }
        .star {
            width: 30px;
            height: 30px;
            color: #ccc; /* Default star color */
            cursor: pointer;
            transition: color 0.2s ease-in-out, transform 0.1s ease-out;
        }
        .star:hover {
            transform: scale(1.1);
        }
        .star.selected {
            color: #FFD700; /* Gold color for selected stars */
        }
        .rating-thank-you {
            font-size: 12px;
            color: #2d5a2d;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <button class="language-toggle">ğŸŒ EN/æ—¥æœ¬èª</button>
            <div class="profile-pic" id="profilePicContainer">
                <!-- Profile picture updated to the new direct Imgur link -->
                <img src="https://i.imgur.com/ThRrtS2.jpeg" alt="AI Assistant" onerror="this.style.display='none'; document.getElementById('avatarFallback').style.display='flex';">
                <div class="avatar-fallback" id="avatarFallback" style="display: none;">ğŸ¤–</div>
            </div>
            <div class="chat-title">Roger's AI Assistant</div> <!-- Will be updated by JS -->
            <div class="chat-subtitle">ãƒ­ã‚¸ãƒ£ãƒ¼ã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</div> <!-- Will be updated by JS -->
        </div>
        <div class="chat-messages" id="chatMessages" role="log" aria-live="polite">
            <!-- Messages will be populated here by JavaScript -->
        </div>
        <div class="chat-input-container" id="chatInputContainer">
            <div id="quickReplies" class="quick-replies hidden">
                <!-- Quick replies will be populated here by JavaScript -->
            </div>
            <div class="chat-input-wrapper">
                <textarea
                    id="chatInput"
                    class="chat-input"
                    placeholder="Type your message..."
                    rows="1"
                ></textarea>
                <button id="sendBtn" class="send-btn" title="Send message">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
        <!-- Message Form -->
        <div class="message-form hidden" id="messageForm">
            <form>
                <div class="form-group">
                    <label class="form-label" id="nameLabel">Your Name:</label>
                    <input type="text" id="formName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" id="companyLabel">Company:</label>
                    <input type="text" id="formCompany" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" id="emailLabel">Email:</label>
                    <input type="email" id="formEmail" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" id="messageLabel">Message for Roger:</label>
                    <textarea id="formMessage" class="form-input form-textarea" required></textarea>
                </div>
                <div class="form-submit-group">
                    <button type="button" class="generate-draft-btn" id="generateDraftBtn">
                        âœ¨ <span id="generateDraftBtnText">Draft Message</span>
                    </button>
                    <button type="submit" class="form-submit" id="submitBtn">Send Message</button>
                </div>
                <div class="close-notice hidden" id="closeNotice">
                    <p id="closeNoticeText"></p>
                    <!-- Removed email content display as it's no longer needed for direct sending -->
                    <!-- Removed copy button as it's no longer needed for direct sending -->
                </div>
            </form>
        </div>
        <!-- Star Rating UI -->
        <div class="chat-rating-container hidden" id="chatRatingContainer">
            <p id="ratingPrompt" class="rating-prompt"></p>
            <div class="stars" id="starRating">
                <svg class="star" data-value="1" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                <svg class="star" data-value="2" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                <svg class="star" data-value="3" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                <svg class="star" data-value="4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                <svg class="star" data-value="5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
            </div>
            <p id="ratingThankYou" class="rating-thank-you hidden"></p>
        </div>
    </div>

    <script>
        // --- Global State Variables ---
        let currentLanguage = 'en'; // Current language of the chat ('en' for English, 'ja' for Japanese)
        let conversationStep = 0;   // Tracks the current step in the conversation flow
        let userInfo = {};          // Stores user-provided information (name, company, etc.)
        let isTyping = false;       // Flag to prevent multiple typing indicators
        let waitingForScheduleConfirmation = false; // Flag for scheduling flow
        let isSchedulingDirectly = false; // NEW FLAG: To indicate if the user chose direct scheduling
        let directScheduleSubStep = 0; // 0: initial, 1: asked name, 2: asked company
        let isLeavingMessageDirectly = false; // NEW FLAG: To indicate if the user chose direct message leaving
        let directMessageSubStep = 0;  // 0: initial, 1: asked name, 2: asked company

        // --- IMPORTANT: Replace this with your deployed Google Apps Script Web App URL ---
        // This URL is obtained after deploying your Google Apps Script (provided in the previous turn)
        // as a web app. Example: 'https://script.google.com/macros/s/AKfycbXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX/exec'
        const GOOGLE_APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbygjlQiVtSYYoQtYOgXl2ES0iauRUsgsakygUYlbC1T1mzeeG54UnT0WD3dO6p2h9zDSg/exec';

        // --- Cached DOM Elements ---
        // These variables will store references to frequently accessed HTML elements
        // to avoid repeated DOM lookups, improving performance.
        let chatMessagesContainer, chatInput, sendButton, quickRepliesContainer,
            chatInputContainer, messageForm, nameLabel, companyLabel, emailLabel,
            messageLabel, submitBtn, closeNotice, chatTitleElement, chatSubtitleElement,
            profilePicImg, avatarFallback, languageToggleButton, generateDraftButton,
            generateDraftButtonText, chatRatingContainer, ratingPrompt, starRatingContainer, ratingThankYou,
            closeNoticeText;


        // --- Localization Data ---
        // Centralized object holding all text strings for different languages.
        // This makes it easy to manage and switch between languages.
        const messages = {
            en: {
                welcome: "ğŸ‘‹ Hello! I'm Roger's AI assistant. I'm here to connect you with Roger.",
                intro: "I can help you:\nâ€¢ Schedule a casual chat with Roger\nâ€¢ Leave a message for Roger\nâ€¢ Hear a greeting from Roger\nâ€¢ Watch Roger's Video\nâ€¢ Connect on LinkedIn", // ADDED: Connect on LinkedIn
                askName: "Great! Let's start. What's your name?",
                askCompany: "Nice to meet you, {name}! What company do you work for?",
                askPurpose: "Thanks, {name}! What brings you here today? Are you looking to:",
                rogerMessage: "Hello and thank you for reaching out!\n\nIâ€™m always eager to connect with forward-thinking teams and explore exciting opportunities where I can make a real impact. Whether youâ€™re hiring for a specific role or just exploring how I could support your business goalsâ€”Iâ€™d love to chat. Letâ€™s discover what we can build together!\nâ€“ Roger",
                afterRogerMessage: "Is there anything else I can help you with?\n\nFeel free to use the buttons below to schedule a chat with Roger or leave a messageâ€”whichever works best for you!",
                scheduleDirectMessage: "Let me take you to the link where you can book a casual chat with Roger.",
                scheduleConfirm: "Perfect! I'll open Roger's calendar for you. You can schedule a time that works best.",
                scheduleFollowUp: "Have you finished scheduling your appointment with Roger?",
                appointmentComplete: "Excellent! Roger will receive your booking confirmation and will be prepared for your meeting. Thank you for connecting with us!",
                windowClosing: "This window will close automatically in 3 seconds...",
                messagePrompt: "I'd be happy to help you send a message to Roger. Please fill out the form below:",
                goodbye: "Thank you for your time! Feel free to reach out anytime.",
                scheduleStillWorking: "No problem! Take your time. Let me know when you're finished scheduling.",
                scheduleHelp: "I can help you with the scheduling process. Would you like me to open the calendar again?",
                generalFallback: "I understand. How else can I help you today?",
                formSending: "Sending...",
                formSent: "Message sent successfully! This window will close in 3 seconds...",
                formError: "Failed to send message. Please try again or contact Roger directly.",
                chatTitleMain: "Roger's AI Assistant",
                chatSubtitleMain: "Connecting you with Roger",
                inputPlaceholder: "Type your message...",
                profileAltText: "AI Assistant",
                generateDraft: "Draft Message",
                generatingDraft: "Generating...",
                draftGenerated: "Draft Generated!",
                rateExperience: "Please rate your experience:",
                thankYouForFeedback: "Thank you for your feedback!",
                watchVideo: "Certainly! Here's Roger's video for recruiters: <a href='https://vimeo.com/1090730386/4c50b956d0' target='_blank' rel='noopener noreferrer' class='video-link'>From Paper to Person</a>",
                linkedinMessage: "Great! Here's a link to Roger's LinkedIn profile: <a href='https://www.linkedin.com/in/meetrogergomes' target='_blank' rel='noopener noreferrer' class='linkedin-link'>linkedin.com/in/meetrogergomes</a>", // NEW: English LinkedIn message
            },
            ja: {
                welcome: "ğŸ‘‹ ã“ã‚“ã«ã¡ã¯ï¼ç§ã¯ãƒ­ã‚¸ãƒ£ãƒ¼ã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ãƒ­ã‚¸ãƒ£ãƒ¼ã¨ã¤ãªãŒã‚‹ãŠæ‰‹ä¼ã„ã‚’ã—ã¾ã™ã€‚",
                intro: "ä»¥ä¸‹ã®ã“ã¨ã‚’ãŠæ‰‹ä¼ã„ã§ãã¾ã™ï¼š\nâ€¢ ãƒ­ã‚¸ãƒ£ãƒ¼ã¨ã®ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãƒãƒ£ãƒƒãƒˆã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«èª¿æ•´\nâ€¢ ãƒ­ã‚¸ãƒ£ãƒ¼ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãŠé ã‹ã‚Š\nâ€¢ ãƒ­ã‚¸ãƒ£ãƒ¼ã‚ˆã‚Šæ­“è¿ã®è¨€è‘‰\nâ€¢ ãƒ­ã‚¸ãƒ£ãƒ¼ã®ãƒ“ãƒ‡ã‚ªã‚’è¦‹ã‚‹\nâ€¢ LinkedInã§ã¤ãªãŒã‚‹", // ADDED: LinkedInã§ã¤ãªãŒã‚‹
                askName: "ç´ æ™´ã‚‰ã—ã„ï¼å§‹ã‚ã¾ã—ã‚‡ã†ã€‚ãŠåå‰ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚",
                askCompany: "{name}ã•ã‚“ã€ã¯ã˜ã‚ã¾ã—ã¦ï¼ã©ã¡ã‚‰ã®ä¼šç¤¾ã«ãŠå‹¤ã‚ã§ã™ã‹ï¼Ÿ",
                askPurpose: "{name}ã•ã‚“ã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼æœ¬æ—¥ã¯ã©ã®ã‚ˆã†ãªã”ç”¨ä»¶ã§ã—ã‚‡ã†ã‹ï¼Ÿ",
                rogerMessage: "ã“ã‚“ã«ã¡ã¯ï¼ã”é€£çµ¡ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚\n\nå¸¸ã«æ–°ã—ã„ã”ç¸ã‚„ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã«ãƒ¯ã‚¯ãƒ¯ã‚¯ã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ãªãƒã‚¸ã‚·ãƒ§ãƒ³ã®ã”ç›¸è«‡ã¯ã‚‚ã¡ã‚ã‚“ã€ã€Œã©ã‚“ãªå½¢ã§åŠ›ã«ãªã‚Œã‚‹ã‹è©±ã—ã¦ã¿ãŸã„ã€ã¨ã„ã†ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãªã”é€£çµ¡ã‚‚å¤§æ­“è¿ã§ã™ã€‚\n\nã”ä¸€ç·’ã«æ–°ã—ã„å¯èƒ½æ€§ã‚’æ¢ã£ã¦ã„ã‘ãŸã‚‰å¬‰ã—ã„ã§ã™ï¼\nâ€“ ãƒ­ã‚¸ãƒ£ãƒ¼",
                afterRogerMessage: "ä»–ã«ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ\n\nãƒ­ã‚¸ãƒ£ãƒ¼ã¨ã®ãƒãƒ£ãƒƒãƒˆäºˆç´„ã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã¯ã€ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ãŠæ°—è»½ã«ã©ã†ãï¼",
                scheduleDirectMessage: "ãƒ­ã‚¸ãƒ£ãƒ¼ã¨ã®ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãªãƒãƒ£ãƒƒãƒˆã‚’äºˆç´„ã§ãã‚‹ãƒªãƒ³ã‚¯ã¸ã”æ¡ˆå†…ã—ã¾ã™ã€‚",
                scheduleConfirm: "å®Œç’§ã§ã™ï¼ãƒ­ã‚¸ãƒ£ãƒ¼ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é–‹ãã¾ã™ã€‚æœ€é©ãªæ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚",
                scheduleFollowUp: "ãƒ­ã‚¸ãƒ£ãƒ¼ã¨ã®ã‚¢ãƒã‚¤ãƒ³ãƒˆãƒ¡ãƒ³ãƒˆã®äºˆç´„ã¯å®Œäº†ã—ã¾ã—ãŸã‹ï¼Ÿ",
                appointmentComplete: "ç´ æ™´ã‚‰ã—ã„ï¼ãƒ­ã‚¸ãƒ£ãƒ¼ãŒäºˆç´„ç¢ºèªã‚’å—ã‘å–ã‚Šã€ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®æº–å‚™ã‚’ã„ãŸã—ã¾ã™ã€‚ã”é€£çµ¡ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼",
                windowClosing: "ã“ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¯3ç§’å¾Œã«è‡ªå‹•çš„ã«é–‰ã˜ã¾ã™...",
                messagePrompt: "ãƒ­ã‚¸ãƒ£ãƒ¼ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãŠé€ã‚Šã™ã‚‹ãŠæ‰‹ä¼ã„ã‚’ã„ãŸã—ã¾ã™ã€‚ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒ ã«ã”è¨˜å…¥ãã ã•ã„ï¼š",
                goodbye: "ãŠæ™‚é–“ã‚’ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼ã„ã¤ã§ã‚‚ãŠæ°—è»½ã«ã”é€£çµ¡ãã ã•ã„ã€‚",
                scheduleStillWorking: "å•é¡Œã‚ã‚Šã¾ã›ã‚“ï¼ã”ã‚†ã£ãã‚Šã©ã†ãã€‚äºˆç´„ãŒå®Œäº†ã—ãŸã‚‰ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚",
                scheduleHelp: "ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®èª¿æ•´ã‚’ãŠæ‰‹ä¼ã„ã§ãã¾ã™ã€‚å†åº¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é–‹ãã¾ã™ã‹ï¼Ÿ",
                generalFallback: "æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚ä»–ã«ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
                formSending: "é€ä¿¡ä¸­...",
                formSent: "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ­£å¸¸ã«é€ä¿¡ã•ã‚Œã¾ã—ãŸï¼ã“ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¯3ç§’å¾Œã«é–‰ã˜ã¾ã™...",
                formError: "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ã„ãŸã ãã‹ã€ç›´æ¥ãƒ­ã‚¸ãƒ£ãƒ¼ã«ã”é€£çµ¡ãã ã•ã„ã€‚",
                chatTitleMain: "Roger's AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ",
                chatSubtitleMain: "ãƒ­ã‚¸ãƒ£ãƒ¼ã¨ã®ã”é€£çµ¡ã‚’ãŠæ‰‹ä¼ã„ã—ã¾ã™",
                inputPlaceholder: "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...",
                profileAltText: "AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ",
                generateDraft: "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸‹æ›¸ãç”Ÿæˆ",
                generatingDraft: "ç”Ÿæˆä¸­...",
                draftGenerated: "ä¸‹æ›¸ãã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼",
                rateExperience: "ä½“é¨“ã¯ã„ã‹ãŒã§ã—ãŸã‹ï¼Ÿ",
                thankYouForFeedback: "ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼",
                watchVideo: "ã¯ã„ã€æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚æ¡ç”¨æ‹…å½“è€…å‘ã‘ã®ãƒ­ã‚¸ãƒ£ãƒ¼ã®ãƒ“ãƒ‡ã‚ªã¯ã“ã¡ã‚‰ã§ã™ï¼š<a href='https://vimeo.com/1090731598/b065f49f38' target='_blank' rel='noopener noreferrer' class='video-link'>æ›¸é¡ã®å…ˆã«ã‚ã‚‹äººç‰©åƒ</a>",
                linkedinMessage: "ã¯ã„ã€æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚ãƒ­ã‚¸ãƒ£ãƒ¼ã®LinkedInãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¯ã“ã¡ã‚‰ã§ã™ï¼š<a href='https://www.linkedin.com/in/meetrogergomes' target='_blank' rel='noopener noreferrer' class='linkedin-link'>linkedin.com/in/meetrogergomes</a>", // NEW: Japanese LinkedIn message
            }
        };

        // Quick replies data for different conversation stages and languages.
        const quickRepliesData = {
            en: {
                start: ["Let's start!", "Tell me more", "Schedule a chat", "Leave a message", "Hear a greeting from Roger", "Watch Roger's Video", "Connect on LinkedIn"], // ADDED: Connect on LinkedIn
                purpose: ["Schedule a chat", "Leave a message", "Roger's greetings", "Watch Roger's Video", "Connect on LinkedIn"], // ADDED: Connect on LinkedIn
                scheduleConfirm: ["Yes, I'm done", "Still working on it", "I need help"]
            },
            ja: {
                start: ["å§‹ã‚ã¾ã—ã‚‡ã†ï¼", "è©³ã—ãæ•™ãˆã¦", "ãƒãƒ£ãƒƒãƒˆã‚’äºˆç´„", "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ®‹ã™", "ãƒ­ã‚¸ãƒ£ãƒ¼ã‚ˆã‚Šæ­“è¿ã®è¨€è‘‰", "ãƒ­ã‚¸ãƒ£ãƒ¼ã®ãƒ“ãƒ‡ã‚ªã‚’è¦‹ã‚‹", "LinkedInã§ã¤ãªãŒã‚‹"], // ADDED: LinkedInã§ã¤ãªãŒã‚‹
                purpose: ["ãƒãƒ£ãƒƒãƒˆã‚’äºˆç´„", "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ®‹ã™", "ãƒ­ã‚¸ãƒ£ãƒ¼ã®ã”ã‚ã„ã•ã¤", "ãƒ­ã‚¸ãƒ£ãƒ¼ã®ãƒ“ãƒ‡ã‚ªã‚’è¦‹ã‚‹", "LinkedInã§ã¤ãªãŒã‚‹"], // ADDED: LinkedInã§ã¤ãªãŒã‚‹
                scheduleConfirm: ["ã¯ã„ã€å®Œäº†ã—ã¾ã—ãŸ", "ã¾ã ä½œæ¥­ä¸­ã§ã™", "ãƒ˜ãƒ«ãƒ—ãŒå¿…è¦"]
            }
        };

        // Form label data for localization.
        const formLabelsData = {
            en: {
                name: "Your Name:",
                company: "Company:",
                email: "Email:",
                message: "Message for Roger:",
                submit: "Send Message"
            },
            ja: {
                name: "ãŠåå‰:",
                company: "ä¼šç¤¾å:",
                email: "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:",
                message: "ãƒ­ã‚¸ãƒ£ãƒ¼ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:",
                submit: "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡"
            }
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            cacheDOMElements();
            initializeEventListeners();
            updateUIForLanguage();
            startConversation();
        });

        /**
         * Caches references to frequently used DOM elements.
         */
        function cacheDOMElements() {
            chatMessagesContainer = document.getElementById('chatMessages');
            chatInput = document.getElementById('chatInput');
            sendButton = document.getElementById('sendBtn');
            quickRepliesContainer = document.getElementById('quickReplies');
            chatInputContainer = document.getElementById('chatInputContainer');
            messageForm = document.getElementById('messageForm');
            nameLabel = document.getElementById('nameLabel');
            companyLabel = document.getElementById('companyLabel');
            emailLabel = document.getElementById('emailLabel');
            messageLabel = document.getElementById('messageLabel');
            submitBtn = document.getElementById('submitBtn');
            closeNotice = document.getElementById('closeNotice');
            chatTitleElement = document.querySelector('.chat-title');
            chatSubtitleElement = document.querySelector('.chat-subtitle');
            profilePicImg = document.querySelector('.profile-pic img');
            avatarFallback = document.getElementById('avatarFallback');
            languageToggleButton = document.querySelector('.language-toggle');
            generateDraftButton = document.getElementById('generateDraftBtn');
            generateDraftButtonText = document.getElementById('generateDraftBtnText');
            chatRatingContainer = document.getElementById('chatRatingContainer');
            ratingPrompt = document.getElementById('ratingPrompt');
            starRatingContainer = document.getElementById('starRating');
            ratingThankYou = document.getElementById('ratingThankYou');
            closeNoticeText = document.getElementById('closeNoticeText');
        }

        /**
         * Initializes all necessary event listeners for interactive elements.
         */
        function initializeEventListeners() {
            chatInput.addEventListener('input', autoResizeTextarea);
            chatInput.addEventListener('keydown', handleInputKeydown);
            sendButton.addEventListener('click', sendMessage);
            languageToggleButton.addEventListener('click', toggleLanguage);
            document.querySelector('#messageForm form').addEventListener('submit', submitMessageForm);
            generateDraftButton.addEventListener('click', generateMessageDraft);
            starRatingContainer.addEventListener('click', handleStarRatingClick);
            starRatingContainer.addEventListener('mouseover', handleStarRatingHover);
            starRatingContainer.addEventListener('mouseout', handleStarRatingOut);
        }

        /**
         * Automatically adjusts the height of the textarea based on its content.
         */
        function autoResizeTextarea() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        }

        /**
         * Handles keydown events in the chat input, specifically for sending messages with Enter.
         */
        function handleInputKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        // --- Core Chat Logic ---

        /**
         * Starts or restarts the conversation flow.
         */
        function startConversation() {
            console.log("startConversation called. Resetting state.");
            conversationStep = 0;
            userInfo = {};
            waitingForScheduleConfirmation = false;
            isTyping = false;
            isSchedulingDirectly = false;
            directScheduleSubStep = 0;
            isLeavingMessageDirectly = false;
            directMessageSubStep = 0;

            chatMessagesContainer.innerHTML = '';
            hideQuickReplies();
            chatInputContainer.classList.remove('hidden');
            messageForm.classList.add('hidden');
            closeNotice.classList.add('hidden');
            chatRatingContainer.classList.add('hidden');
            resetStars();

            setTimeout(async () => {
                await addBotMessage(messages[currentLanguage].welcome);
                setTimeout(async () => {
                    await addBotMessage(messages[currentLanguage].intro);
                    showQuickReplies('start');
                }, 1500);
            }, 1000);
        }

        /**
         * Appends a message to the chat display.
         */
        function addMessageToDOM(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            const formattedText = text.replace(/\n/g, '<br>');
            messageDiv.innerHTML = formattedText;

            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            messageDiv.appendChild(timeDiv);

            chatMessagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        /**
         * Adds a bot message to the chat, optionally with a typing indicator.
         */
        function addBotMessage(text, showTypingEffect = true) {
            return new Promise(resolve => {
                if (showTypingEffect) {
                    showTypingIndicator();
                    const typingTime = Math.min(text.length * 30, 2000);
                    setTimeout(() => {
                        hideTypingIndicator();
                        addMessageToDOM(text, 'bot');
                        resolve();
                    }, typingTime);
                } else {
                    addMessageToDOM(text, 'bot');
                    resolve();
                }
            });
        }

        /**
         * Displays a typing indicator in the chat.
         */
        function showTypingIndicator() {
            if (isTyping) return;
            isTyping = true;
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `<div class="typing-dots"><span></span><span></span><span></span></div>`;
            chatMessagesContainer.appendChild(typingDiv);
            scrollToBottom();
        }

        /**
         * Hides the typing indicator from the chat.
         */
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
            isTyping = false;
        }

        /**
         * Sends a user message.
         */
        function sendMessage() {
            const messageText = chatInput.value.trim();
            if (!messageText || isTyping) return;

            addMessageToDOM(messageText, 'user');
            chatInput.value = '';
            autoResizeTextarea.call(chatInput);
            hideQuickReplies();
            disableInput();

            processUserMessage(messageText);
        }

        /**
         * Initiates the direct scheduling flow.
         */
        async function initiateDirectScheduling() {
            console.log("initiateDirectScheduling called.");
            isSchedulingDirectly = true;
            directScheduleSubStep = 1;
            await addBotMessage(messages[currentLanguage].askName);
            enableInput();
            console.log("End of initiateDirectScheduling: isSchedulingDirectly =", isSchedulingDirectly, ", directScheduleSubStep =", directScheduleSubStep);
        }

        /**
         * Initiates the direct message leaving flow.
         */
        async function initiateDirectMessage() {
            console.log("initiateDirectMessage called.");
            isLeavingMessageDirectly = true;
            directMessageSubStep = 1;
            await addBotMessage(messages[currentLanguage].askName);
            enableInput();
            console.log("End of initiateDirectMessage: isLeavingMessageDirectly =", isLeavingMessageDirectly, ", directMessageSubStep =", directMessageSubStep);
        }

        /**
         * Processes the user's message based on the current conversation step and direct flow states.
         */
        async function processUserMessage(message) {
            console.log("processUserMessage called. Current message:", message);
            console.log("Before processing: conversationStep =", conversationStep, ", userInfo =", JSON.stringify(userInfo), ", isSchedulingDirectly =", isSchedulingDirectly, ", directScheduleSubStep =", directScheduleSubStep, ", isLeavingMessageDirectly =", isLeavingMessageDirectly, ", directMessageSubStep =", directMessageSubStep, ", waitingForScheduleConfirmation =", waitingForScheduleConfirmation);

            await delay(500);

            const lowerMessage = message.toLowerCase();
            const lang = currentLanguage;

            // --- Priority 1: Handle active direct scheduling flow ---
            if (isSchedulingDirectly) {
                if (directScheduleSubStep === 1) {
                    userInfo.name = message;
                    console.log("Name stored for direct scheduling: userInfo.name =", userInfo.name);
                    await addBotMessage(messages[lang].askCompany.replace('{name}', userInfo.name || (lang === 'en' ? 'there' : 'çš†æ§˜')));
                    directScheduleSubStep = 2;
                } else if (directScheduleSubStep === 2) {
                    userInfo.company = message;
                    console.log("Company stored for direct scheduling: userInfo.company =", userInfo.company);
                    const directScheduleMsg = messages[lang].scheduleDirectMessage;
                    await addBotMessage(directScheduleMsg);
                    await delay(1000);
                    window.open('https://calendly.com/gomes-roger333', '_blank');
                    await delay(5000);
                    waitingForScheduleConfirmation = true;
                    await addBotMessage(messages[lang].scheduleFollowUp);
                    showQuickReplies('scheduleConfirm');
                    isSchedulingDirectly = false;
                    directScheduleSubStep = 0;
                    conversationStep = 99;
                } else {
                    console.warn("Unexpected sub-step in direct scheduling flow. Resetting.");
                    await addBotMessage(messages[lang].generalFallback);
                    startConversation();
                }
                enableInput();
                console.log("Handled ongoing direct scheduling. State:", { conversationStep, userInfo, isSchedulingDirectly, directScheduleSubStep });
                return;
            }

            // --- Priority 2: Handle active direct message leaving flow ---
            if (isLeavingMessageDirectly) {
                if (directMessageSubStep === 1) {
                    userInfo.name = message;
                    console.log("Name stored for direct message: userInfo.name =", userInfo.name);
                    await addBotMessage(messages[lang].askCompany.replace('{name}', userInfo.name || (lang === 'en' ? 'there' : 'çš†æ§˜')));
                    directMessageSubStep = 2;
                } else if (directMessageSubStep === 2) {
                    userInfo.company = message;
                    console.log("Company stored for direct message: userInfo.company =", userInfo.company);
                    await addBotMessage(messages[lang].messagePrompt);
                    await delay(1500);
                    showMessageForm();
                    isLeavingMessageDirectly = false;
                    directMessageSubStep = 0;
                    conversationStep = 99;
                } else {
                    console.warn("Unexpected sub-step in direct message leaving flow. Resetting.");
                    await addBotMessage(messages[lang].generalFallback);
                    startConversation();
                }
                enableInput();
                console.log("Handled ongoing direct message leaving. State:", { conversationStep, userInfo, isLeavingMessageDirectly, directMessageSubStep });
                return;
            }

            // --- Priority 3: Handle post-scheduling confirmation ---
            if (waitingForScheduleConfirmation) {
                await handleScheduleFollowUp(message);
                enableInput();
                console.log("Handled schedule confirmation. State:", { waitingForScheduleConfirmation });
                return;
            }

            // --- Priority 4: Initial Intent Detection / General conversation flow ---
            const rogerGreetingKeywords = [
                messages[lang].intro.split('\n')[2].toLowerCase().replace('â€¢ ', ''),
                "roger's greetings", "greeting", "ãƒ­ã‚¸ãƒ£ãƒ¼ã®ã”ã‚ã„ã•ã¤", "ã”ã‚ã„ã•ã¤", "æ­“è¿"
            ];
            const isRogerGreetingIntent = rogerGreetingKeywords.some(keyword => lowerMessage.includes(keyword));

            if (isRogerGreetingIntent) {
                await addBotMessage(messages[lang].rogerMessage);
                await delay(2500);
                await addBotMessage(messages[lang].afterRogerMessage);
                showQuickReplies('purpose');
                enableInput();
                conversationStep = 99;
                console.log("Handled Roger Greeting. State:", { conversationStep, userInfo });
                return;
            }

            const videoIntentKeywords = [
                (messages[lang].intro.split('\n')[3] || '').toLowerCase().replace('â€¢ ', ''),
                "watch video", "video", "ãƒ“ãƒ‡ã‚ª", "è¦‹ã‚‹", "movie", "å‹•ç”»"
            ];
            const isVideoIntent = videoIntentKeywords.some(keyword => lowerMessage.includes(keyword));

            if (isVideoIntent) {
                await addBotMessage(messages[lang].watchVideo);
                await delay(2500);
                await addBotMessage(messages[lang].afterRogerMessage);
                showQuickReplies('purpose');
                enableInput();
                conversationStep = 99;
                console.log("Handled Watch Video intent. State:", { conversationStep, userInfo });
                return;
            }

            // NEW: Handle LinkedIn Intent
            const linkedinIntentKeywords = [
                (messages[lang].intro.split('\n')[4] || '').toLowerCase().replace('â€¢ ', ''), // For the new LinkedIn line
                "linkedin", "connect on linkedin", "ã¤ãªãŒã‚‹", "ãƒªãƒ³ã‚¯ãƒˆã‚¤ãƒ³", "ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«"
            ];
            const isLinkedInIntent = linkedinIntentKeywords.some(keyword => lowerMessage.includes(keyword));

            if (isLinkedInIntent) {
                await addBotMessage(messages[lang].linkedinMessage);
                await delay(2500);
                await addBotMessage(messages[lang].afterRogerMessage);
                showQuickReplies('purpose');
                enableInput();
                conversationStep = 99;
                console.log("Handled LinkedIn intent. State:", { conversationStep, userInfo });
                return;
            }

            const scheduleIntentKeywords = [
                quickRepliesData[lang].purpose[0].toLowerCase().split(" ")[0],
                "schedule", "chat", "äºˆç´„", "ãƒãƒ£ãƒƒãƒˆ", "book", "calendly", "ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼"
            ];
            const isScheduleIntent = scheduleIntentKeywords.some(keyword => lowerMessage.includes(keyword));

            if (isScheduleIntent) {
                initiateDirectScheduling();
                console.log("Initiated direct scheduling. State:", { conversationStep, userInfo, isSchedulingDirectly, directScheduleSubStep });
                return;
            }

            const messageIntentKeywords = [
                quickRepliesData[lang].purpose[1].toLowerCase().split(" ")[0],
                "message", "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", "leave a message", "é€£çµ¡"
            ];
            const isMessageIntent = messageIntentKeywords.some(keyword => lowerMessage.includes(keyword));

            if (isMessageIntent) {
                initiateDirectMessage();
                console.log("Initiated direct message leaving. State:", { conversationStep, userInfo, isLeavingMessageDirectly, directMessageSubStep });
                return;
            }


            // --- Fallback: General conversation flow ---
            if (conversationStep < 99) {
                conversationStep++;
            }
            console.log("After general flow conversationStep increment/check: conversationStep =", conversationStep);

            switch(conversationStep) {
                case 1:
                    await addBotMessage(messages[currentLanguage].askName);
                    break;
                case 2:
                    userInfo.name = message;
                    console.log("Name stored in general flow: userInfo.name =", userInfo.name);
                    const companyMsg = messages[currentLanguage].askCompany.replace('{name}', userInfo.name || "there");
                    await addBotMessage(companyMsg);
                    break;
                case 3:
                    userInfo.company = message;
                    console.log("Company stored in general flow: userInfo.company =", userInfo.company);
                    const purposeMsg = messages[currentLanguage].askPurpose.replace('{name}', userInfo.name || "there");
                    await addBotMessage(purposeMsg);
                    showQuickReplies('purpose');
                    break;
                default:
                    await addBotMessage(messages[currentLanguage].generalFallback);
                    showQuickReplies('purpose');
                    conversationStep = 3;
                    break;
            }
            enableInput();
            console.log("End of processUserMessage (final): conversationStep =", conversationStep, ", userInfo =", JSON.stringify(userInfo));
        }

        /**
         * Handles the user's selection of purpose (schedule, message, learn, video, linkedin).
         * This function is primarily for when the user selects a purpose *after* name/company are known.
         */
        async function handlePurposeSelection(message) {
            console.log("handlePurposeSelection called. Message:", message);
            const lowerMessage = message.toLowerCase();
            const lang = currentLanguage;

            if (lowerMessage.includes(quickRepliesData[lang].purpose[0].toLowerCase().split(" ")[0]) || lowerMessage.includes("schedule") || lowerMessage.includes("chat") || lowerMessage.includes("äºˆç´„") || lowerMessage.includes("ãƒãƒ£ãƒƒãƒˆ")) {
                const directScheduleMsg = messages[lang].scheduleDirectMessage;
                await addBotMessage(directScheduleMsg);
                await delay(1000);
                window.open('https://calendly.com/gomes-roger333', '_blank');
                await delay(5000);
                waitingForScheduleConfirmation = true;
                await addBotMessage(messages[lang].scheduleFollowUp);
                showQuickReplies('scheduleConfirm');
            }
            else if (lowerMessage.includes(quickRepliesData[lang].purpose[1].toLowerCase().split(" ")[0]) || lowerMessage.includes("message") || lowerMessage.includes("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸")) {
                await addBotMessage(messages[lang].messagePrompt);
                await delay(1500);
                showMessageForm();
            }
            else if (lowerMessage.includes(quickRepliesData[lang].purpose[2].toLowerCase().split(" ")[0]) || lowerMessage.includes("roger's greetings") || lowerMessage.includes("ãƒ­ã‚¸ãƒ£ãƒ¼ã®ã”ã‚ã„ã•ã¤") || lowerMessage.includes("learn") || lowerMessage.includes("çµŒæ­´") || lowerMessage.includes("ã«ã¤ã„ã¦") || lowerMessage.includes("greeting") || lowerMessage.includes("æ­“è¿")) {
                await addBotMessage(messages[lang].rogerMessage);
                await delay(2500);
                await addBotMessage(messages[lang].afterRogerMessage);
                showQuickReplies('purpose');
            }
            else if (lowerMessage.includes((quickRepliesData[lang].purpose[3] || '').toLowerCase().split(" ")[0]) || lowerMessage.includes("watch video") || lowerMessage.includes("ãƒ“ãƒ‡ã‚ªã‚’è¦‹ã‚‹") || lowerMessage.includes("video") || lowerMessage.includes("è¦‹ã‚‹") || lowerMessage.includes("movie") || lowerMessage.includes("å‹•ç”»")) {
                 await addBotMessage(messages[lang].watchVideo);
                 await delay(2500);
                 await addBotMessage(messages[lang].afterRogerMessage);
                 showQuickReplies('purpose');
            }
            // NEW: Handle LinkedIn intent here for direct typing or purpose quick replies
            else if (lowerMessage.includes((quickRepliesData[lang].purpose[4] || '').toLowerCase().split(" ")[0]) || lowerMessage.includes("linkedin") || lowerMessage.includes("connect on linkedin") || lowerMessage.includes("ã¤ãªãŒã‚‹") || lowerMessage.includes("ãƒªãƒ³ã‚¯ãƒˆã‚¤ãƒ³") || lowerMessage.includes("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«")) {
                await addBotMessage(messages[lang].linkedinMessage);
                await delay(2500);
                await addBotMessage(messages[lang].afterRogerMessage);
                showQuickReplies('purpose');
            }
            else {
                await addBotMessage(messages[lang].generalFallback);
                showQuickReplies('purpose');
            }
            console.log("End of handlePurposeSelection.");
        }

        /**
         * Handles follow-up responses after opening the scheduling calendar.
         */
        async function handleScheduleFollowUp(message) {
            console.log("handleScheduleFollowUp called. Message:", message);
            const lowerMessage = message.toLowerCase();
            const lang = currentLanguage;
            waitingForScheduleConfirmation = false;

            if (lowerMessage.includes(quickRepliesData[lang].scheduleConfirm[0].toLowerCase().split(" ")[0]) || lowerMessage.includes("yes") || lowerMessage.includes("ã¯ã„")) {
                await addBotMessage(messages[lang].appointmentComplete);
                await delay(2000);
                showRatingPrompt();
            }
            else if (lowerMessage.includes(quickRepliesData[lang].scheduleConfirm[1].toLowerCase().split(" ")[0]) || lowerMessage.includes("still") || lowerMessage.includes("ã¾ã ")) {
                await addBotMessage(messages[lang].scheduleStillWorking);
                showQuickReplies('scheduleConfirm');
                waitingForScheduleConfirmation = true;
            }
            else {
                await addBotMessage(messages[lang].scheduleHelp);
                showQuickReplies('scheduleConfirm');
                waitingForScheduleConfirmation = true;
            }
            console.log("End of handleScheduleFollowUp.");
        }

        // --- UI Updates & Interactions ---

        /**
         * Displays the message form and hides the chat input.
         */
        function showMessageForm() {
            console.log("showMessageForm called.");
            chatInputContainer.classList.add('hidden');
            quickRepliesContainer.classList.add('hidden');
            messageForm.classList.remove('hidden');
            chatRatingContainer.classList.add('hidden');
            resetStars();
            updateFormLabels();
            if (userInfo.name) document.getElementById('formName').value = userInfo.name;
            if (userInfo.company) document.getElementById('formCompany').value = userInfo.company;
            document.getElementById('formEmail').focus();
            document.getElementById('formMessage').value = '';
            console.log("End of showMessageForm.");
        }

        /**
         * Updates the text content of form labels based on the current language.
         */
        function updateFormLabels() {
            const labels = formLabelsData[currentLanguage];
            nameLabel.textContent = labels.name;
            companyLabel.textContent = labels.company;
            emailLabel.textContent = labels.email;
            messageLabel.textContent = labels.message;
            submitBtn.textContent = labels.submit;
            generateDraftButtonText.textContent = messages[currentLanguage].generateDraft;
        }

        /**
         * Handles the submission of the message form by sending data to Google Apps Script.
         */
        async function submitMessageForm(event) {
            event.preventDefault();
            console.log("submitMessageForm called.");

            const formData = {
                name: document.getElementById('formName').value,
                company: document.getElementById('formCompany').value,
                email: document.getElementById('formEmail').value,
                message: document.getElementById('formMessage').value
            };

            submitBtn.disabled = true;
            generateDraftButton.disabled = true;
            submitBtn.textContent = messages[currentLanguage].formSending;
            closeNotice.classList.remove('hidden');
            closeNoticeText.textContent = messages[currentLanguage].formSending;

            console.log("Form data to be sent:", formData);

            try {
                if (GOOGLE_APPS_SCRIPT_WEB_APP_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE' || !GOOGLE_APPS_SCRIPT_WEB_APP_URL.startsWith('https://script.google.com/macros/s/')) {
                    throw new Error("Google Apps Script Web App URL is not configured correctly. Please update the GOOGLE_APPS_SCRIPT_WEB_APP_URL constant in the script.");
                }

                const response = await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                });

                console.log("Response from Apps Script (due to no-cors, cannot read body):", response);

                closeNoticeText.textContent = messages[currentLanguage].formSent;
                showRatingPrompt();

            } catch (error) {
                console.error("Error sending message to Apps Script:", error);
                closeNoticeText.textContent = messages[currentLanguage].formError;
            } finally {
                setTimeout(() => {
                    messageForm.classList.add('hidden');
                    chatInputContainer.classList.remove('hidden');
                    closeNotice.classList.add('hidden');
                    startConversation();
                    submitBtn.disabled = false;
                    generateDraftButton.disabled = false;
                }, 3000);
            }
            console.log("End of submitMessageForm.");
        }

        /**
         * Function to generate a message draft using Gemini API.
         */
        async function generateMessageDraft() {
            console.log("generateMessageDraft called.");
            const formMessageInput = document.getElementById('formMessage');
            const userIntent = formMessageInput.value.trim();
            const userName = document.getElementById('formName').value.trim();
            const userCompany = document.getElementById('formCompany').value.trim();

            if (!userIntent) {
                formMessageInput.value = "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ„å›³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n(Please enter your message intent.)";
                return;
            }

            generateDraftButton.disabled = true;
            generateDraftButtonText.textContent = messages[currentLanguage].generatingDraft;
            generateDraftButton.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                let prompt;
                if (currentLanguage === 'en') {
                    prompt = `Draft a professional email/message to Roger. The user's name is "${userName}", their company is "${userCompany}". Their message intent is: "${userIntent}". Ensure the draft is concise, professional, and clearly conveys the user's purpose.`;
                } else {
                    prompt = `ãƒ­ã‚¸ãƒ£ãƒ¼ã¸ã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ¡ãƒ¼ãƒ«/ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¸‹æ›¸ãã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå‰ã¯ã€Œ${userName}ã€ã€ä¼šç¤¾ã¯ã€Œ${userCompany}ã€ã§ã™ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ„å›³ã¯ã€Œ${userIntent}ã€ã§ã™ã€‚ä¸‹æ›¸ãã¯ç°¡æ½”ã§ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§ã‚ã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç›®çš„ã‚’æ˜ç¢ºã«ä¼ãˆã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚`;
                }

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    formMessageInput.value = text;
                    generateDraftButtonText.textContent = messages[currentLanguage].draftGenerated;
                } else {
                    formMessageInput.value = messages[currentLanguage].generalFallback;
                }
            } catch (error) {
                console.error("Error generating message draft:", error);
                formMessageInput.value = "ä¸‹æ›¸ãã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n(Error generating draft.)";
            } finally {
                generateDraftButton.disabled = false;
                generateDraftButton.classList.remove('opacity-50', 'cursor-not-allowed');
                setTimeout(() => {
                    generateDraftButtonText.textContent = messages[currentLanguage].generateDraft;
                }, 2000);
                autoResizeTextarea.call(formMessageInput);
            }
            console.log("End of generateMessageDraft.");
        }


        /**
         * Displays quick reply buttons in the chat interface.
         */
        function showQuickReplies(type) {
            console.log("showQuickReplies called. Type:", type);
            quickRepliesContainer.innerHTML = '';
            quickRepliesContainer.dataset.replyType = type;
            const replies = quickRepliesData[currentLanguage][type];

            if (replies) {
                replies.forEach(reply => {
                    const button = document.createElement('button');
                    button.className = 'quick-reply';
                    button.textContent = reply;
                    button.onclick = () => handleQuickReply(reply);
                    quickRepliesContainer.appendChild(button);
                });
                quickRepliesContainer.classList.remove('hidden');
                scrollToBottom();
            }
            console.log("End of showQuickReplies.");
        }

        /**
         * Handles a click on a quick reply button.
         */
        function handleQuickReply(replyText) {
            console.log("handleQuickReply called. Reply Text:", replyText);
            addMessageToDOM(replyText, 'user');
            hideQuickReplies();
            disableInput();

            const lang = currentLanguage;
            const lowerReplyText = replyText.toLowerCase();
            const currentQuickReplyType = quickRepliesData[lang].start; // Use quickRepliesData[lang].start directly for initial intent matching from start quick replies

            // Check if the current quick reply was from the 'start' set
            if (quickRepliesContainer.dataset.replyType === 'start') {
                if (lowerReplyText === currentQuickReplyType[4].toLowerCase()) { // "Hear a greeting from Roger" / "ãƒ­ã‚¸ãƒ£ãƒ¼ã‚ˆã‚Šæ­“è¿ã®è¨€è‘‰"
                    processUserMessage(replyText);
                } else if (lowerReplyText === currentQuickReplyType[5].toLowerCase()) { // "Watch Roger's Video" / "ãƒ­ã‚¸ãƒ£ãƒ¼ã®ãƒ“ãƒ‡ã‚ªã‚’è¦‹ã‚‹"
                    processUserMessage(replyText);
                } else if (lowerReplyText === currentQuickReplyType[6].toLowerCase()) { // "Connect on LinkedIn" / "LinkedInã§ã¤ãªãŒã‚‹"
                    processUserMessage(replyText);
                } else if (lowerReplyText === currentQuickReplyType[2].toLowerCase()) { // "Schedule a chat" / "ãƒãƒ£ãƒƒãƒˆã‚’äºˆç´„"
                    initiateDirectScheduling();
                } else if (lowerReplyText === currentQuickReplyType[3].toLowerCase()) { // "Leave a message" / "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ®‹ã™"
                    initiateDirectMessage();
                } else { // "Let's start!" or "Tell me more"
                    processUserMessage(replyText);
                }
            } else if (quickRepliesContainer.dataset.replyType === 'purpose') { // Check if the current quick reply was from the 'purpose' set
                const currentPurposeReplies = quickRepliesData[lang].purpose;
                if (lowerReplyText === currentPurposeReplies[0].toLowerCase()) { // "Schedule a chat"
                    initiateDirectScheduling();
                } else if (lowerReplyText === currentPurposeReplies[1].toLowerCase()) { // "Leave a message"
                    initiateDirectMessage();
                } else if (lowerReplyText === currentPurposeReplies[2].toLowerCase()) { // "Roger's greetings"
                    processUserMessage(replyText);
                } else if (lowerReplyText === currentPurposeReplies[3].toLowerCase()) { // "Watch Roger's Video"
                    processUserMessage(replyText);
                } else if (lowerReplyText === currentPurposeReplies[4].toLowerCase()) { // "Connect on LinkedIn"
                    processUserMessage(replyText);
                } else {
                    processUserMessage(replyText);
                }
            } else if (quickRepliesContainer.dataset.replyType === 'scheduleConfirm') { // Handle scheduleConfirm quick replies
                processUserMessage(replyText);
            }
            console.log("End of handleQuickReply.");
        }

        /**
         * Hides the quick replies container.
         */
        function hideQuickReplies() {
            quickRepliesContainer.classList.add('hidden');
        }

        /**
         * Disables the chat input and send button.
         */
        function disableInput() {
            chatInput.disabled = true;
            sendButton.disabled = true;
        }

        /**
         * Enables the chat input and send button, and focuses on the input.
         */
        function enableInput() {
            chatInput.disabled = false;
            sendButton.disabled = false;
            chatInput.focus();
        }

        /**
         * Scrolls the chat messages container to the bottom to show the latest message.
         */
        function scrollToBottom() {
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        /**
         * Toggles the current language between English and Japanese.
         */
        function toggleLanguage() {
            console.log("toggleLanguage called. Current language:", currentLanguage);
            currentLanguage = (currentLanguage === 'en') ? 'ja' : 'en';
            updateUIForLanguage();
            startConversation();
            console.log("Language toggled to:", currentLanguage);
        }

        /**
         * Updates static UI elements (chat title, subtitle, input placeholder, form labels)
         * based on the `currentLanguage`.
         */
        function updateUIForLanguage() {
            chatTitleElement.textContent = messages[currentLanguage].chatTitleMain;
            chatSubtitleElement.textContent = messages[currentLanguage].chatSubtitleMain;
            chatInput.placeholder = messages[currentLanguage].inputPlaceholder;
            profilePicImg.alt = messages[currentLanguage].profileAltText;
            updateFormLabels();
            ratingPrompt.textContent = messages[currentLanguage].rateExperience;
            ratingThankYou.textContent = messages[currentLanguage].thankYouForFeedback;
        }

        /**
         * Displays the star rating prompt.
         */
        function showRatingPrompt() {
            console.log("showRatingPrompt called.");
            chatInputContainer.classList.add('hidden');
            messageForm.classList.add('hidden');
            quickRepliesContainer.classList.add('hidden');
            chatRatingContainer.classList.remove('hidden');
            ratingPrompt.textContent = messages[currentLanguage].rateExperience;
            ratingThankYou.classList.add('hidden');
            resetStars();
            scrollToBottom();
            console.log("End of showRatingPrompt.");
        }

        /**
         * Handles click event on stars for rating.
         */
        async function handleStarRatingClick(event) {
            console.log("handleStarRatingClick called.");
            const clickedStar = event.target.closest('.star');
            if (clickedStar) {
                const rating = parseInt(clickedStar.dataset.value);
                console.log("User rated:", rating, "stars");
                const stars = Array.from(starRatingContainer.children);
                stars.forEach(star => {
                    if (parseInt(star.dataset.value) <= rating) {
                        star.classList.add('selected');
                    } else {
                        star.classList.remove('selected');
                    }
                });

                ratingThankYou.textContent = messages[currentLanguage].thankYouForFeedback;
                ratingThankYou.classList.remove('hidden');

                starRatingContainer.style.pointerEvents = 'none';

                setTimeout(async () => {
                    chatRatingContainer.classList.add('hidden');
                    await addBotMessage(messages[currentLanguage].goodbye);
                    await delay(3000);
                    disableInput();
                    hideQuickReplies();
                    console.log("Chat ended after rating.");
                }, 2000);
            }
            console.log("End of handleStarRatingClick.");
        }

        /**
         * Handles hover effect for stars.
         */
        function handleStarRatingHover(event) {
            const hoveredStar = event.target.closest('.star');
            if (hoveredStar && starRatingContainer.style.pointerEvents !== 'none') {
                const hoverValue = parseInt(hoveredStar.dataset.value);
                const stars = Array.from(starRatingContainer.children);
                stars.forEach(star => {
                    if (parseInt(star.dataset.value) <= hoverValue) {
                        star.classList.add('selected');
                    } else {
                        star.classList.remove('selected');
                    }
                });
            }
        }

        /**
         * Handles mouseout effect for stars (resets to no selection if no star was clicked).
         */
        function handleStarRatingOut(event) {
            if (starRatingContainer.style.pointerEvents !== 'none') {
                resetStars();
            }
        }

        /**
         * Resets all stars to their default unselected state.
         */
        function resetStars() {
            const stars = Array.from(starRatingContainer.children);
            stars.forEach(star => star.classList.remove('selected'));
            starRatingContainer.style.pointerEvents = 'auto';
        }

        /**
         * A utility function to create a delay using Promises, allowing for async/await.
         */
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
